@model List<DashboardReportApp.Models.SinterRunSkid>
@using System.Text.Json;

@{
    ViewData["Title"] = "Sintering Run Log";

    // 1) Operators from the DB
    var operators = ViewData["Operators"] as List<string> ?? new List<string>();

    // 2) Get open skids from the ViewBag (for green skids)
    var openGreenSkids = ViewBag.OpenGreenSkids as List<DashboardReportApp.Models.PressRunLogModel>
                   ?? new List<DashboardReportApp.Models.PressRunLogModel>();
    // List of furnaces for the modal dropdown
    var furnaces = ViewData["Furnaces"] as List<string> ?? new List<string>();
}

<div class="container-fluid px-3">
    <h1 class="text-center mb-4">Sintering Run Log</h1>

    <h2 class="text-center mb-4">Green Skids Available to be Sintered</h2>
    <!-- Green Skids Table -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered shadow-sm wider-table">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Prod Number</th>
                            <th>Run</th>
                            <th>Part</th>
                            <th>End DateTime</th>
                            <th>Operator</th>
                            <th>Machine</th>
                            <th>Skid Number</th>
                            <th>Pcs on Skid</th>
                            <th>Notes</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pressRun in openGreenSkids)
                        {
                            <tr>
                                <td>@pressRun.Id</td>
                                <td>@pressRun.ProdNumber</td>
                                <td>@pressRun.Run</td>
                                <td>@pressRun.Part</td>
                                <td>@(pressRun.EndDateTime?.ToString("g") ?? "N/A")</td>
                                <td>@pressRun.Operator</td>
                                <td>@pressRun.Machine</td>
                                <td>@pressRun.SkidNumber</td>
                                <td>@(pressRun.PcsEnd - pressRun.PcsStart)</td>
                                <td>@pressRun.Notes</td>
                                <td>
                                    <!-- Only Login button is here -->
                                    <button class="btn btn-primary btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#loginSkidModal"
                                            data-id="@pressRun.Id"
                                            data-prodnumber="@pressRun.ProdNumber"
                                            data-run="@pressRun.Run"
                                            data-part="@pressRun.Part"
                                            data-machine="@pressRun.Machine"
                                            data-operator="@pressRun.Operator"
                                            data-notes="@pressRun.Notes"
                                            data-pcsstart="@pressRun.PcsStart"
                                            data-pcsend="@pressRun.PcsEnd"
                                            data-skidnumber="@pressRun.SkidNumber">
                                        Login to Skid Run
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function updateHiddenRun() {
            const partSelect = document.getElementById("Part");
            const prodHidden = document.getElementById("ProdNumber");
            const runHidden = document.getElementById("RunNumber");
            const selectedOption = partSelect.options[partSelect.selectedIndex];

            if (!selectedOption) {
                console.error("No option selected!");
                return;
            }

            const selectedRun = selectedOption.getAttribute("data-run") || "";
            const selectedProdNumber = selectedOption.getAttribute("prodNum") || "";
            prodHidden.value = selectedProdNumber;
            runHidden.value = selectedRun; // Set the hidden run value
            console.log("Selected Run:", selectedRun);
        }
    </script>

    <!-- Open Sintering Production Skid Runs -->
    <h2 class="text-center mb-4">Open Sintering Production Skid Runs</h2>
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered shadow-sm wider-table">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Timestamp</th>
                            <th>Production Number</th>
                            <th>Run</th>
                            <th>Part</th>
                            <th>Start Time</th>
                            <th>Operator</th>
                            <th>Furnace</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var skid in Model.Where(s => s.EndDateTime == null))
                        {
                            // Find the corresponding green skid (press run) record based on ProdNumber and Part
                            var matchingPressRun = openGreenSkids.FirstOrDefault(pr =>
                            pr.ProdNumber == skid.ProdNumber &&
                            pr.Part == skid.Part &&
                            pr.SkidNumber == skid.SkidNumber);

                            // Compute the difference (if found) or default to 0
                            var pcsDiff = matchingPressRun != null ? (matchingPressRun.PcsEnd - matchingPressRun.PcsStart) : 0;

                            <tr>
                                <td>@skid.Id</td>
                                <td>@skid.Timestamp</td>
                                <td>@skid.ProdNumber</td>
                                <td>@skid.Run</td>
                                <td>@skid.Part</td>
                                <td>@skid.StartDateTime</td>
                                <td>@skid.Operator</td>
                                <td>@skid.Machine</td>
                                <td>
                                    <!-- End Skid button now passes the computed pcsDiff -->
                                    <button class="btn btn-warning btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#endSkidModal"
                                            data-prodnumber="@skid.ProdNumber"
                                            data-part="@skid.Part"
                                            data-skidnumber="@skid.SkidNumber"
                                            data-pcs="@pcsDiff"
                                            data-run="@skid.Run"
                                            data-operator="@skid.Operator"
                                            data-machine="@skid.Machine"
                                            data-process="@skid.Process"
                                            data-notes="@skid.Notes">
                                        End Skid
                                    </button>
                                    <!-- Logout button remains unchanged -->
                                    <button class="btn btn-danger btn-sm ms-1"
                                            data-bs-toggle="modal"
                                            data-bs-target="#stopSinteringModal"
                                            data-part="@skid.Part"
                                            data-run="@skid.Run"
                                            data-starttime="@skid.StartDateTime"
                                            data-skidnumber="@skid.SkidNumber">
                                        Logout of Skid Run
                                    </button>

                                </td>
                            </tr>
                        }


                    </tbody>

                </table>
            </div>
        </div>
    </div>

    <!-- Full List of Records (React Table) -->
    <h3 class="text-center mt-4">All Sinter Run Records</h3>
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="container-fluid px-3 mt-4">
                <div id="myReactSinterRunTableRoot"
                     data-records='@Html.Raw(JsonSerializer.Serialize(Model))'>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/mydatatable.bundle.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const container = document.getElementById("myReactSinterRunTableRoot");
            if (!container) return;

            // Get JSON data from the Razor model
            const rawData = container.getAttribute("data-records");
            const data = JSON.parse(rawData);

            // Define columns for the React table
            const columns = [
                { key: "Id", label: "ID" },
                { key: "Timestamp", label: "Timestamp" },
                { key: "Operator", label: "Operator" },
                { key: "ProdNumber", label: "Production Number" },
                { key: "Run", label: "Run" },
                { key: "Part", label: "Part" },
                { key: "Machine", label: "Furnace" },
                { key: "Process", label: "Process" },
                { key: "StartDateTime", label: "Start Time" },
                { key: "EndDateTime", label: "End Time" },
                { key: "Notes", label: "Notes" },
                { key: "Open", label: "Open" }
            ];

            if (window.renderMyDataTable) {
                window.renderMyDataTable("myReactSinterRunTableRoot", data, columns, true);
            } else {
                console.error("React table render function not found!");
            }
        });
    </script>

    <!-- Modal for Logging In a Skid Run -->
    <div class="modal fade" id="loginSkidModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login Skid Run</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/SinterRunLog/LoginToSkid">
                        <!-- Hidden fields -->
                        <input type="hidden" id="pressRunId" name="pressRunId" />
                        <input type="hidden" id="ProdNumber" name="ProdNumber" />
                        <input type="hidden" id="Run" name="Run" />
                        <input type="hidden" id="Part" name="Part" />
                        <input type="hidden" id="SkidNumber" name="SkidNumber" />

                        <!-- Display Part -->
                        <div class="mb-3">
                            <label class="form-label" style="color: goldenrod;">Part</label>
                            <p id="displayPart" class="form-control-plaintext" style="color: goldenrod;"></p>
                        </div>

                        <!-- Editable field for PCS and display Skid Count -->
                        <div class="mb-3">
                            <label for="Pcs" class="form-label">PCS</label>
                            <input type="number" id="Pcs" name="Pcs" class="form-control" required />
                        </div>

                        <!-- Display Skid Count as read-only -->
                        <div class="mb-3">
                            <label class="form-label">Skid Count</label>
                            <p id="displaySkidNumber" class="form-control-" style="color: #000; font-weight: bold;"></p>
                        </div>

                        <div class="mb-3">
                            <label for="Operator" class="form-label">Operator</label>
                            <select id="Operator" name="Operator" class="form-select" required>
                                <option value="">Select an Operator</option>
                                @foreach (var op in operators)
                                {
                                    <option value="@op">@op</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="Machine" class="form-label">Furnace</label>
                            <select id="Machine" name="Machine" class="form-select" required>
                                <option value="">Select a Furnace</option>
                                @foreach (var furnace in furnaces)
                                {
                                    <option value="@furnace">@furnace</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="Process" class="form-label">Process</label>
                            <select id="Process" name="Process" class="form-select" required>
                                <option value="Sinter">Sinter</option>
                                <option value="Anneal">Anneal</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="Notes" class="form-label">Notes</label>
                            <textarea id="Notes" name="Notes" class="form-control"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Login Skid Run</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var loginSkidModal = document.getElementById('loginSkidModal');
            loginSkidModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;

                // Extract data from the button's data-* attributes
                var pressRunId = button.getAttribute('data-id');
                var prodNumber = button.getAttribute('data-prodnumber');
                var run = button.getAttribute('data-run');
                var part = button.getAttribute('data-part');
                var machine = button.getAttribute('data-machine');
                var notes = button.getAttribute('data-notes');
                var pcsStartStr = button.getAttribute('data-pcsstart');
                var pcsEndStr = button.getAttribute('data-pcsend');
                var skidNumber = button.getAttribute('data-skidnumber');

                // Calculate the PCS difference using parseFloat
                var pcs = 0;
                if (pcsStartStr && pcsEndStr) {
                    pcs = parseFloat(pcsEndStr) - parseFloat(pcsStartStr);
                }

                // Populate hidden inputs
                loginSkidModal.querySelector('#pressRunId').value = pressRunId;
                loginSkidModal.querySelector('#ProdNumber').value = prodNumber;
                loginSkidModal.querySelector('#Run').value = run;
                loginSkidModal.querySelector('#Part').value = part;
                loginSkidModal.querySelector('#SkidNumber').value = skidNumber;
                loginSkidModal.querySelector('#Pcs').value = pcs;

                // Display values in read-only elements
                loginSkidModal.querySelector('#displayPart').textContent = part;
                loginSkidModal.querySelector('#displaySkidNumber').textContent = skidNumber;
                loginSkidModal.querySelector('#displaySkidNumber').style.color = "#000";
                loginSkidModal.querySelector('#displaySkidNumber').style.fontWeight = "bold";

                // Preselect the furnace if possible
                var machineSelect = loginSkidModal.querySelector('#Machine');
                machineSelect.value = machine || "";

                // Pre-fill the notes field if provided
                loginSkidModal.querySelector('#Notes').value = notes || "";
            });
        });
    </script>

    <!-- Modal for Ending Skid Run -->
    <div class="modal fade" id="endSkidModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">End Skid Run</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/SinterRunLog/EndSkid">
                        <!-- Hidden fields for required data -->
                        <input type="hidden" id="end_prodNumber" name="prodNumber" />
                        <input type="hidden" id="end_part" name="part" />
                        <input type="hidden" id="end_skidNumber" name="skidNumber" />
                        <input type="hidden" id="end_pcs" name="pcs" />
                        <!-- Extra hidden fields for additional data -->
                        <input type="hidden" id="end_run" name="run" />
                        <input type="hidden" id="end_oper" name="oper" />
                        <input type="hidden" id="end_oven" name="oven" />
                        <input type="hidden" id="end_process" name="process" />
                        <input type="hidden" id="end_notes" name="notes" />

                        <p>Please confirm ending the skid run for the following:</p>
                        <p><strong>Prod Number:</strong> <span id="end_displayProdNumber"></span></p>
                        <p><strong>Part:</strong> <span id="end_displayPart"></span></p>
                        <p><strong>Skid Number:</strong> <span id="end_displaySkidNumber"></span></p>
                        <p><strong>Pcs:</strong> <span id="end_displayPcs"></span></p>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">End Skid</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
                  document.addEventListener("DOMContentLoaded", function() {
            var endSkidModal = document.getElementById('endSkidModal');
            endSkidModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget; // Button that triggered the modal

                // Extract the required data attributes, including the computed pcs difference
                var prodNumber = button.getAttribute('data-prodnumber');
                var part = button.getAttribute('data-part');
                var skidNumber = button.getAttribute('data-skidnumber');
                var pcs = button.getAttribute('data-pcs');

                var run = button.getAttribute('data-run') || "";
                var oper = button.getAttribute('data-operator') || "";
                var oven = button.getAttribute('data-machine') || "";
                var process = button.getAttribute('data-process') || "";
                var notes = button.getAttribute('data-notes') || "";

                // Populate hidden inputs in the modal form
                endSkidModal.querySelector('#end_prodNumber').value = prodNumber;
                endSkidModal.querySelector('#end_part').value = part;
                endSkidModal.querySelector('#end_skidNumber').value = skidNumber;
                endSkidModal.querySelector('#end_pcs').value = pcs;
                endSkidModal.querySelector('#end_run').value = run;
                endSkidModal.querySelector('#end_oper').value = oper;
                endSkidModal.querySelector('#end_oven').value = oven;
                endSkidModal.querySelector('#end_process').value = process;
                endSkidModal.querySelector('#end_notes').value = notes;

                // Populate visible confirmation spans
                endSkidModal.querySelector('#end_displayProdNumber').textContent = prodNumber;
                endSkidModal.querySelector('#end_displayPart').textContent = part;
                endSkidModal.querySelector('#end_displaySkidNumber').textContent = skidNumber;
                endSkidModal.querySelector('#end_displayPcs').textContent = pcs;
            });
        });


    </script>

    <!-- Modal for Logging Out (Stopping) a Skid Run -->
    <!-- Modal for Logging Out (Stopping) a Skid Run -->
    <div class="modal fade" id="stopSinteringModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stop Sintering Run</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="stopSinteringForm" method="post" action="/SinterRunLog/LogoutOfSkid">
                        <!-- Hidden fields for required data -->
                        <input type="hidden" id="modalRunId" name="run" />
                        <input type="hidden" id="modalStartTime" name="startTime" />
                        <input type="hidden" id="modalSkidNumber" name="skidNumber" />
                        <!-- Display Part as read-only -->
                        <div class="mb-3">
                            <label class="form-label">Part Number</label>
                            <input type="text" id="modalPart" class="form-control" name="part" readonly />
                        </div>
                        <p class="text-danger">Are you sure you want to logout of this sintering skid run?</p>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Logout of Skid Run</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
               document.addEventListener("DOMContentLoaded", function() {
            var stopSinteringModal = document.getElementById('stopSinteringModal');
            stopSinteringModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget; // Button that triggered the modal

                // Extract data from the button's data-* attributes
                var part = button.getAttribute('data-part');
                var run = button.getAttribute('data-run');
                var startTime = button.getAttribute('data-starttime');
                var skidNumber = button.getAttribute('data-skidnumber');

                // Populate the modal fields
                stopSinteringModal.querySelector('#modalPart').value = part;
                stopSinteringModal.querySelector('#modalRunId').value = run;
                stopSinteringModal.querySelector('#modalStartTime').value = startTime;
                stopSinteringModal.querySelector('#modalSkidNumber').value = skidNumber;
            });
        });

    </script>

    <script>
        function openStopSinteringModal(runId, part, run, startDateTime) {
            if (!confirm(`Are you sure you want to stop sintering for ${part} (Run: ${run}) started at ${startDateTime}?`)) {
                return;
            }
            console.log("Stopping sintering:", { runId, part, run, startDateTime });
            const form = document.createElement("form");
            form.method = "post";
            form.action = "/SinterRunLog/LogoutOfSkid";
            const partInput = document.createElement("input");
            partInput.type = "hidden";
            partInput.name = "part";
            partInput.value = part;
            form.appendChild(partInput);
            const runInput = document.createElement("input");
            runInput.type = "hidden";
            runInput.name = "run";
            runInput.value = run;
            form.appendChild(runInput);
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</div>
