
@model DashboardReportApp.Models.SecondaryRunLogViewModel

<div class="container-fluid mt-4">
    <h2 class="text-center mb-4">Secondary Run Log</h2>

    <!-- Add New Run Form -->
    <div class="card shadow p-4 mb-4">
        <h4>Add New Run</h4>
        <form asp-action="CreateRun" method="post">
            <div class="mb-3">
                <label for="runNumber" class="form-label">Run #</label>
                <input type="text" id="runNumber" name="runNumber" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="operatorName" class="form-label">Operator</label>
                <select id="operatorName" name="operatorName" class="form-control" required>
                    <option value="" disabled selected>Select an operator</option>
                    @foreach (var operatorName in Model.Operators)
                    {
                        <option value="@operatorName">@operatorName</option>
                    }
                </select>
            </div>
            <div class="mb-3">
                <label for="machine" class="form-label">Machine</label>
                <select id="machine" name="machine" class="form-control" required>
                    <option value="" disabled selected>Select a machine</option>
                    @foreach (var machine in Model.Machines)
                    {
                        <option value="@machine">@machine</option>
                    }
                </select>
            </div>
            <div class="mb-3">
                <label for="op" class="form-label">Op</label>
                <input type="text" id="op" name="op" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3">Add Run</button>
        </form>
    </div>

    <!-- Open Runs Table -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered shadow-sm w-100">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Timestamp</th>
                    <th>Run #</th>
                    <th>Part</th>
                    <th>Op</th>
                    <th>Operator</th>
                    <th>Start Time</th>
                    <th>Machine</th>
                    <th>Notes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var run in Model.OpenRuns)
                {
                    <tr>
                        <td>@run.Id</td>
                        <td>@run.Timestamp</td>
                        <td>@run.Run</td>
                        <td>@run.Part</td>
                        <td>@run.Op</td>
                        <td>@run.Operator</td>
                        <td>@run.StartDateTime</td>
                        <td>@run.Machine</td>
                        <td>@run.Notes</td>
                        <td>
                            <button class="btn btn-warning btn-sm w-100"
                                    onclick="showCloseForm(@run.Id, '@run.Run', '@run.Operator', '@run.Machine', '@run.StartDateTime', '@run.Notes')">
                                Close
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Close Run Form -->
    <div id="closeRunForm" class="card shadow p-4 mt-4" style="display: none;">
        <h4>Close Run</h4>
        <form asp-action="CloseRun" method="post">
            <input type="hidden" id="closeRunId" name="id" />
            <p><strong>Run #:</strong> <span id="closeRunRunNumber"></span></p>
            <p><strong>Operator:</strong> <span id="closeRunOperator"></span></p>
            <p><strong>Machine:</strong> <span id="closeRunMachine"></span></p>
            <p><strong>Start Time:</strong> <span id="closeRunStartTime"></span></p>
            <p><strong>Notes:</strong> <span id="closeRunNotes"></span></p>
            <div class="mb-3">
                <label for="pcs" class="form-label">Pieces Ran</label>
                <input type="number" id="pcs" name="pcs" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="scrapMach" class="form-label">Machined Scrap</label>
                <input type="number" id="scrapMach" name="scrapMach" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="scrapNonMach" class="form-label">Non-Machined Scrap</label>
                <input type="number" id="scrapNonMach" name="scrapNonMach" class="form-control" required />
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea id="notes" name="notes" class="form-control text-area-large" rows="3"></textarea>
            </div>
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary w-50">Close Run</button>
                <button type="button" class="btn btn-secondary w-50" onclick="hideCloseForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>



<!-- Custom Styles -->
<style>
    .btn {
        transition: 0.3s ease-in-out;
    }

    .btn:hover {
        transform: scale(1.05);
    }

    .text-area-large {
        min-height: 150px !important;
    }

    .table-responsive {
        overflow-x: auto;
        display: block;
    }

    .w-100 {
        width: 100% !important;
    }
</style>

@section Scripts {
    <script>
                   function showCloseForm(id, run, operator, machine, startTime, notes) {
            document.getElementById('closeRunId').value = id;
            document.getElementById('closeRunRunNumber').innerText = run && run.trim() ? run : "Not Available"; // Fix for Run #
            document.getElementById('closeRunOperator').innerText = operator && operator.trim() ? operator : "Not Available";
            document.getElementById('closeRunMachine').innerText = machine && machine.trim() ? machine : "Not Available";
            document.getElementById('closeRunStartTime').innerText = startTime && startTime.trim() ? startTime : "Not Available";
            document.getElementById('closeRunNotes').innerText = notes && notes.trim() ? notes : "None";

            document.getElementById('closeRunForm').style.display = 'block';
            document.getElementById('closeRunForm').scrollIntoView({ behavior: "smooth" });
        }


        function hideCloseForm() {
            document.getElementById('closeRunForm').style.display = 'none';
        }
    </script>
}
