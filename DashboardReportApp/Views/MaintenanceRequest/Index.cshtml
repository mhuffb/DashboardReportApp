@model IEnumerable<MaintenanceRequestModel>
@using System.Text.Json;
@{
    var isAdmin = (ViewBag.IsAdmin as bool?) ?? false;
    var operators = ViewBag.OperatorNames as List<string> ?? new List<string>();
}

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<div class="container-fluid px-3 mt-4">
    <h1 class="text-center mb-4">Maintenance Requests</h1>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- QR helper text -->
    <div class="row justify-content-center">
        <h5 class="text-center mb-4">
            You can upload pictures from your phone by connecting to Wi-Fi then viewing this page on your phone.
        </h5>
    </div>

    <!-- Combined QR Codes -->
    <div class="d-flex justify-content-evenly align-items-center mb-4">
        <!-- Wi-Fi QR Code -->
        <div class="text-center">
            <canvas id="wifi-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">Connect to Wifi</div>
        </div>
        <!-- Current Page QR Code -->
        <div class="text-center">
            <canvas id="current-page-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">View on your device</div>
        </div>
    </div>
</div>

<!-- Add Request (Razor) -->
<div class="d-flex justify-content-center mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReqModal">
        <i class="bi bi-plus"></i> Add Request
    </button>
</div>

<!-- Add Request Modal (unchanged, your current Razor modal) -->
<div class="modal fade" id="addReqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addReqForm" class="modal-content" enctype="multipart/form-data">
            <div class="modal-header">
                <h5 class="modal-title">Add Maintenance Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Equipment</label>
                    <select class="form-control" id="equipSelect" name="Equipment" required>
                        <option value="">Select Equipment</option>
                        <!-- options filled by JS from window.equipmentList -->
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Requester</label>
                    <select class="form-control" id="requesterSelect" name="Requester" required>
                        <option value="">-- Select Requester --</option>
                        <!-- options filled by JS from window.requesters -->
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Problem</label>
                    <textarea class="form-control" name="Problem" id="problemInput" required></textarea>
                </div>

                <div class="mb-2">
                    <label class="form-label">Department</label>
                    <select class="form-control" name="Department" required>
                        <option value="">-- Select Department --</option>
                        <option value="Finishing">Finishing</option>
                        <option value="General">General</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Molding">Molding</option>
                        <option value="Packing">Packing</option>
                        <option value="Quality">Quality</option>
                        <option value="Secondary">Secondary</option>
                        <option value="Sintering">Sintering</option>
                        <option value="Tooling">Tooling</option>
                    </select>
                </div>

                <div class="form-check mb-2">
                    <input type="checkbox" class="form-check-input" id="downStatusCheck" name="DownStatus" value="true">
                    <label class="form-check-label" for="downStatusCheck">Machine Down?</label>
                </div>

                <div class="form-check mb-2">
                    <input type="checkbox" class="form-check-input" id="safetyConcern" name="SafetyConcern" value="true">
                    <label class="form-check-label" for="safetyConcern">Is this a safety concern?</label>
                </div>

                <div class="mb-2">
                    <label class="form-label">Upload File 1</label>
                    <input type="file" class="form-control" name="file" accept="image/*,application/pdf,video/*">
                </div>

                <!-- Hidden defaults the controller expects -->
                <input type="hidden" name="Status" value="Open">
                <input type="hidden" name="StatusDesc" value="">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="submitAddReq" type="submit" class="btn btn-success">
                    Submit
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ✅ SERVER-RENDERED TABLE (replaces React root) -->
<div class="container-fluid px-3">
    <div class="table-responsive">
        <table id="maintenanceTable" class="custom-table table-striped table-bordered shadow-sm w-100">
            @{
                var colCount = isAdmin ? 13 : 12;
            }
            <thead class="table-dark">
                <tr>
                    <th style="width:3%; text-align:center;">ID</th>
                    <th style="width:12%; text-align:center;">Equipment</th>
                    <th style="width:7%; text-align:center;">Requester</th>
                    <th style="width:6%; text-align:center;">Requested Date</th>
                    <th style="width:17%; text-align:center;">Problem</th>
                    <th style="width:6%; text-align:center;">Status</th>
                    <th style="width:19%; text-align:center;">Status Desc</th>
                    <th style="width:8%; text-align:center;">Department</th>
                    <th style="width:7%; text-align:center;">Safety Concern</th>
                    <th style="width:7%; text-align:center;">File 1</th>
                    <th style="width:7%; text-align:center;">Update File 1</th>
                    <th style="width:7%; text-align:center;">File 2</th>
                    @if (isAdmin)
                    {
                        <th style="width:7%; text-align:center;">Actions</th>
                    }
                </tr>
            </thead>

            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var row in Model)
                    {
                        var equipmentDisplay = row.Equipment;
                        <tr>
                            <td class="text-center">@row.Id</td>
                            <td>@equipmentDisplay</td>
                            <td>@row.Requester</td>
                            <td>@(row.RequestedDate?.ToString("yyyy-MM-dd") ?? "")</td>
                            <td>@row.Problem</td>
                            <td>@row.Status</td>
                            <td>@row.StatusDesc</td>
                            <td>@row.Department</td>
                            <td class="text-center">
                                @(row.SafetyConcern ? "🚨" : "")
                            </td>

                            <!-- FileAddress1 Preview -->
                            <td class="text-center">
                                @if (!string.IsNullOrEmpty(row.FileAddress1))
                                {
                                    <button type="button"
                                            class="btn btn-info btn-sm btn-preview"
                                            data-file="@row.FileAddress1">
                                        <i class="bi bi-eye"></i> Preview
                                    </button>
                                }
                                else
                                {
                                    <span>No File</span>
                                }
                            </td>

                            <!-- Update FileAddress1 -->
                            <td class="text-center">
                                <form action="/MaintenanceRequest/UpdateFileAddress1"
                                      method="post"
                                      enctype="multipart/form-data"
                                      id="updateFileAddress1Form-@row.Id">
                                    <input type="hidden" name="id" value="@row.Id" />
                                    <input type="file"
                                           name="file"
                                           accept="image/*,application/pdf,video/*"
                                           class="file-input-1 d-none"
                                           id="fileInput-@row.Id" />
                                    <button type="button"
                                            class="btn btn-primary btn-sm w-100 btn-add-file"
                                            data-target-input="fileInput-@row.Id"
                                            data-target-form="updateFileAddress1Form-@row.Id">
                                        Add File 1
                                    </button>
                                </form>
                            </td>

                            <!-- FileAddress2 Preview -->
                            <td class="text-center">
                                @if (!string.IsNullOrEmpty(row.FileAddress2))
                                {
                                    <button type="button"
                                            class="btn btn-info btn-sm btn-preview"
                                            data-file="@row.FileAddress2">
                                        <i class="bi bi-eye"></i> Preview
                                    </button>
                                }
                                else
                                {
                                    <span>No File</span>
                                }
                            </td>

                            @if (isAdmin)
                            {
                                <!-- REAL Actions column cell -->
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-primary btn-sm btn-admin-edit"
                                            data-id="@row.Id">
                                        Edit
                                    </button>
                                </td>
                            }
                        </tr>
                    }

                }
                else
                {
                    <tr>
                        <td colspan="@colCount" class="text-center">No data found</td>
                    </tr>

                }
            </tbody>
        </table>
    </div>
</div>
@if (isAdmin)
{
    <div class="modal fade" id="adminEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="adminEditForm"
                  class="modal-content"
                  method="post"
                  action="/MaintenanceAdmin/UpdateRequest"
                  enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Maintenance Request</h5>
                    <button type="button" class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="Id" id="editId" />
                    <input type="hidden" name="Equipment" id="editEquipment" />
                    <input type="hidden" name="Requester" id="editRequester" />
                    <input type="hidden" name="RequestedDate" id="editRequestedDate" />
                    <input type="hidden" name="Problem" id="editProblem" />
                    <input type="hidden" name="Department" id="editDepartment" />
                    <input type="hidden" name="HourMeter" id="editHourMeter" />
                    <input type="hidden" name="SafetyConcern" id="editSafetyConcern" />
                    <input type="hidden" name="ClosedDateTime" id="editClosedDateTime" />

                    <div class="mb-2">
                        <label class="form-label">Current Status History</label>
                        <textarea class="form-control"
                              id="editStatusDesc"
                              name="StatusDesc"
                              readonly
                              style="min-height:80px"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editStatus" name="Status">
                            <option value="Open">Open</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New Status Note</label>
                        <textarea class="form-control"
                              id="editNewStatusDesc"
                              name="NewStatusDesc"
                              style="min-height:60px"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Status Updated By</label>
                        <select class="form-control"
                                id="editStatusUpdatedBy"
                                name="StatusUpdatedBy">
                            <option value="">-- Select Operator --</option>
                            @foreach (var op in operators)
                            {
                                <option value="@op">@op</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">File 1 (replace / add)</label>
                        <input type="hidden" id="editFile1String" name="FileAddress1" />
                        <input type="file"
                               class="form-control"
                               name="FileAddress1"
                               accept="image/*,application/pdf,video/*" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">File 2 (replace / add)</label>
                        <input type="hidden" id="editFile2String" name="FileAddress2" />
                        <input type="file"
                               class="form-control"
                               name="FileAddress2"
                               accept="image/*,application/pdf,video/*" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
}
<!-- Preview Modal (replaces React preview modal) -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContainer" class="w-100"></div>
            </div>
        </div>
    </div>
</div>

<!-- Global variables for JS (same data you used for React, now just for the add modal) -->
<script type="text/javascript">
    window.equipmentList = @Html.Raw(JsonSerializer.Serialize(ViewData["EquipmentList"]));
    window.requesters = @Html.Raw(JsonSerializer.Serialize(ViewData["Requesters"]));


</script>
@if (isAdmin)
{
    <script type="text/javascript">
        window.isAdmin = true;
        window.maintenanceRequests = @Html.Raw(JsonSerializer.Serialize(Model));
    </script>
}
else
{
    <script type="text/javascript">
        window.isAdmin = false;
    </script>
}

<!-- QR Code Generation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Generate QR code for the current page
        var currentUrl = window.location.href;
        QRCode.toCanvas(document.getElementById('current-page-qr'), currentUrl, {
            width: 128
        }, function (error) {
            if (error) console.error(error);
        });

        // Generate QR code for Wi-Fi connection
        var wifiData = 'WIFI:T:WPA;S:Sintergy-WiFi;P:5intergyW1F1;;';
        QRCode.toCanvas(document.getElementById('wifi-qr'), wifiData, {
            width: 128
        }, function (error) {
            if (error) console.error(error);
        });
    });
</script>

<!-- JS: fill selects + AJAX add request + DataTables + preview + file upload -->
<script>
    (function () {
        const modalEl = document.getElementById('addReqModal');
        const formEl = document.getElementById('addReqForm');
        const equipEl = document.getElementById('equipSelect');
        const reqEl = document.getElementById('requesterSelect');

            function fillSelects() {
        try {
            const equipmentList = Array.isArray(window.equipmentList) ? window.equipmentList.slice() : [];
            equipmentList.sort((a, b) => {
                const aNum = parseInt(String(a).split(' - ')[0], 10);
                const bNum = parseInt(String(b).split(' - ')[0], 10);
                return (isNaN(aNum) || isNaN(bNum))
                    ? String(a).localeCompare(String(b))
                    : aNum - bNum;
            });

            equipEl.innerHTML = '<option value="">Select Equipment</option>' +
                equipmentList.map(eq => `<option>${eq}</option>`).join('');

            const adminEquipFilter = document.getElementById('adminEquipmentFilter');
            if (adminEquipFilter) {
                adminEquipFilter.innerHTML =
                    '<option value="">-- Select Equipment --</option>' +
                    equipmentList.map(eq => `<option>${eq}</option>`).join('');
            }

            const requesters = Array.isArray(window.requesters)
                ? window.requesters.slice().sort()
                : [];
            reqEl.innerHTML = '<option value="">-- Select Requester --</option>' +
                requesters.map(r => `<option>${r}</option>`).join('');
        } catch (e) {
            console.error('fillSelects failed', e);
        }
    }


        modalEl?.addEventListener('shown.bs.modal', fillSelects);

        const show = (msg) =>
            (typeof window.showSpinner === 'function' ? window.showSpinner() : null);
        const hide = () =>
            (typeof window.hideSpinner === 'function' ? window.hideSpinner() : null);

        // Submit handler (AJAX) for Add Request
        formEl?.addEventListener('submit', async (ev) => {
            ev.preventDefault();

            try {
                show('Submitting…');

                const fd = new FormData(formEl);

                // Only send numeric equipment before " - "
                const equipFull = fd.get('Equipment') || '';
                if (typeof equipFull === 'string' && equipFull.includes(' - ')) {
                    fd.set('Equipment', equipFull.split(' - ')[0].trim());
                }

                fd.set('DownStatus', document.getElementById('downStatusCheck').checked ? 'true' : 'false');
                fd.set('SafetyConcern', document.getElementById('safetyConcern').checked ? 'true' : 'false');

                const resp = await fetch('/MaintenanceRequest/AddRequest', {
                    method: 'POST',
                    body: fd
                });

                if (!resp.ok) {
                    let msg = 'Failed to add request.';
                    try {
                        const j = await resp.json();
                        if (j?.message) msg = j.message;
                    } catch { }
                    throw new Error(msg);
                }

                const json = await resp.json();
                if (!json?.success) {
                    throw new Error(json?.message || 'Server rejected the request.');
                }

                const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                bsModal.hide();
                setTimeout(() => { window.location.reload(); }, 50);

            } catch (err) {
                hide();
                console.error(err);
                if (window.Swal) Swal.fire('Error', err.message || 'Network error', 'error');
                else alert(err.message || 'Network error');
            }
        });

        if (document.readyState !== 'loading') fillSelects();
        else document.addEventListener('DOMContentLoaded', fillSelects, { once: true });

        // 🔹 DataTables init (like Tooling Work Orders)
           document.addEventListener('DOMContentLoaded', function () {
        if (window.jQuery && $.fn.DataTable) {
            const table = $('#maintenanceTable').DataTable({
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                order: [[0, 'desc']]
            });

            if (window.isAdmin) {
                const $search = $('#adminSearch');
                if ($search.length) {
                    $search.on('keyup change', function () {
                        table.search(this.value).draw();
                    });
                }

                // custom date + equipment filter
                $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                    if (settings.nTable.id !== 'maintenanceTable') return true;

                    const reqDateStr = data[3] || ''; // Requested Date column
                    const equipStr = data[1] || '';   // Equipment column

                    const startVal = $('#adminStartDate').val();
                    const endVal = $('#adminEndDate').val();
                    const selectedEquip = $('#adminEquipmentFilter').val();

                    // Date range
                    if (startVal || endVal) {
                        if (!reqDateStr) return false;
                        const rowDate = new Date(reqDateStr);
                        if (startVal && rowDate < new Date(startVal)) return false;
                        if (endVal && rowDate > new Date(endVal)) return false;
                    }

                    // Equipment filter
                    if (selectedEquip && equipStr !== selectedEquip) {
                        return false;
                    }

                    return true;
                });

                $('#adminStartDate, #adminEndDate, #adminEquipmentFilter').on('change', function () {
                    table.draw();
                });

                $('#clearFiltersBtn').on('click', function () {
                    $('#adminSearch').val('');
                    $('#adminStartDate').val('');
                    $('#adminEndDate').val('');
                    $('#adminEquipmentFilter').val('');

                    table.search('').draw();
                    table.draw();
                });
            }
        } else {
            console.warn('DataTables not found; table will be plain HTML.');
        }
    });


        // 🔹 File preview logic (delegated so it works with pagination)
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-preview');
            if (!btn) return;

            const fileName = btn.getAttribute('data-file');
            if (!fileName) return;

            try {
                    const controller = window.isAdmin ? 'MaintenanceAdmin' : 'MaintenanceRequest';
    const resp = await fetch(`/${controller}/FetchImage?filePath=` + encodeURIComponent(fileName));

                if (!resp.ok) {
                    alert('Failed to fetch file.');
                    return;
                }
                const data = await resp.json();
                if (!data.success || !data.url) {
                    alert(data.message || 'Could not retrieve file from server.');
                    return;
                }

                   const url = data.url;
    const container = document.getElementById('previewContainer');
    if (!container) return;

    container.innerHTML = '';

    const lowerName = (fileName || '').toLowerCase();
    const isPdf = lowerName.endsWith('.pdf');
    const isVideo = lowerName.endsWith('.mp4')
        || lowerName.endsWith('.webm')
        || lowerName.endsWith('.ogg')
        || lowerName.endsWith('.mov')
        || lowerName.endsWith('.m4v');

    // PDF
    if (isPdf) {
        const embed = document.createElement('embed');
        embed.src = url;
        embed.type = 'application/pdf';
        embed.style.width = '100%';
        embed.style.height = '600px';
        container.appendChild(embed);
    }
    // VIDEO
    else if (isVideo) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        video.style.width = '100%';
        video.style.maxHeight = '80vh';
        container.appendChild(video);
    }
    // IMAGE (fallback)
    else {
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Preview';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '80vh';
        container.appendChild(img);
    }

    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();


              
            } catch (err) {
                console.error('Error fetching file:', err);
                alert('Error fetching file.');
            }
        });

        // 🔹 "Add File 1" => click hidden file input, submit form with spinner
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-add-file');
            if (!btn) return;

            const inputId = btn.getAttribute('data-target-input');
            const formId = btn.getAttribute('data-target-form');
            const fileInput = document.getElementById(inputId);
            const form = document.getElementById(formId);

            if (!fileInput || !form) return;

            fileInput.click();

            // On file change, submit the form
            fileInput.addEventListener('change', function handler(ev) {
                fileInput.removeEventListener('change', handler);
                if (fileInput.files && fileInput.files.length > 0) {
                    if (typeof window.showSpinner === 'function') window.showSpinner();
                    form.submit();
                }
            });
        });
    })();




        // 🔹 Admin "Edit" button logic
    if (window.isAdmin && Array.isArray(window.maintenanceRequests)) {
        const reqMap = new Map();
        window.maintenanceRequests.forEach(r => {
            if (r && typeof r.Id !== 'undefined') {
                reqMap.set(r.Id, r);
            }
        });

        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-admin-edit');
            if (!btn) return;

            const id = parseInt(btn.getAttribute('data-id'), 10);
            if (!id || !reqMap.has(id)) return;

            const row = reqMap.get(id);
            populateAdminEditModal(row);
            const modalEl = document.getElementById('adminEditModal');
            if (!modalEl) return;
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        function normalizeDate(dStr) {
            if (!dStr) return '';
            if (dStr.indexOf('T') >= 0) return dStr.split('T')[0];
            return dStr;
        }

        function populateAdminEditModal(row) {
            document.getElementById('editId').value = row.Id;
            document.getElementById('editEquipment').value = row.Equipment || '';
            document.getElementById('editRequester').value = row.Requester || '';
            document.getElementById('editRequestedDate').value = normalizeDate(row.RequestedDate);
            document.getElementById('editProblem').value = row.Problem || '';
            document.getElementById('editDepartment').value = row.Department || '';
            document.getElementById('editHourMeter').value = row.HourMeter != null ? row.HourMeter : '';
            document.getElementById('editSafetyConcern').value = row.SafetyConcern ? 'true' : 'false';
            document.getElementById('editClosedDateTime').value = normalizeDate(row.ClosedDateTime);

            document.getElementById('editStatus').value = row.Status || 'Open';
            document.getElementById('editStatusDesc').value = row.StatusDesc || '';
            document.getElementById('editNewStatusDesc').value = '';
            document.getElementById('editStatusUpdatedBy').value = '';

            document.getElementById('editFile1String').value = row.FileAddress1 || '';
            document.getElementById('editFile2String').value = row.FileAddress2 || '';
        }
    }

</script>
