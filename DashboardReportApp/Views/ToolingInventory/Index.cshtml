@model List<DashboardReportApp.Models.ToolItemModel>
@using DashboardReportApp.Models
@{
    ViewData["Title"] = "Tooling Inventory";
}

<div class="container-fluid px-3">
    <h2 class="text-center mb-3">Tooling Inventory</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

   
    <!-- ====================== In Progress Tools (from Tooling WorkOrder) ====================== -->
    @if (ViewBag.ToolingInProgress != null)
    {
        <div class="table-responsive mb-4">
            <h3 class="mb-2">In Progress Tools</h3>
            <table class="table table-striped table-bordered shadow-sm w-100" id="tblInProgress">
                <thead class="table-dark">
                    <tr>
                        <th style="width:48px;"></th>  <!-- expand -->
                        <th>Group</th>
                        <th>Assembly #</th>
                        <th>Reason</th>
                        <th>Vendor</th>
                        <th>Initiated</th>
                        <th>Due</th>
                        <th>Cost</th>
                        <th style="min-width:260px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (DashboardReportApp.Models.ToolingHistoryModel item in ViewBag.ToolingInProgress)
                    {
                        var rowId = $"row-items-{item.GroupID}";
                        var reason = (item.Reason ?? string.Empty).Trim();
                        var showPackingSlip = !reason.Equals("New Customer Purchase (5030)", StringComparison.OrdinalIgnoreCase);

                        <tr data-group="@item.GroupID">
                            <td>
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary"
                                        data-action="toggle-items"
                                        data-group="@item.GroupID"
                                        aria-expanded="false"
                                        aria-controls="@rowId"
                                        title="Show tool items">
                                    <i class="bi bi-caret-right-fill"></i>
                                </button>
                            </td>
                            <td>@item.GroupID</td>
                            <td>@item.Part</td>
                            <td>@item.Reason</td>
                            <td>@item.ToolVendor</td>
                            <td>@item.DateInitiated.ToShortDateString()</td>
                            <td>@item.DateDue?.ToShortDateString()</td>
                            <td>@(item.Cost?.ToString("0.00"))</td>
                            <td class="d-flex flex-wrap gap-2">
                                <div class="btn-group btn-group-sm">

                                    <a class="btn btn-primary btn-sm"
                                       href="@Url.Action("EditToolingWorkOrderModalByGroup", "ToolingWorkOrder", new { groupID = item.GroupID })"
                                       data-bs-toggle="modal" data-bs-target="#toolingWorkOrderModal">
                                        Edit Tool Work Order
                                    </a>

                                    <a class="btn btn-secondary btn-sm"
                                       href="@Url.Action("ToolItemsModalByGroup", "ToolingWorkOrder", new { groupID = item.GroupID })"
                                       data-bs-toggle="modal" data-bs-target="#toolingWorkOrderModal">
                                        Add/Edit Tool Items
                                    </a>

                                </div>

                                <form asp-action="RequestPoNumber" asp-controller="ToolingWorkOrder" method="post" class="request-po-form d-inline-block">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@item.Id" />
                                    @{
                                        bool hasPo = !string.IsNullOrWhiteSpace(item.PO);
                                        bool wasRequested = item.PoRequestedAt.HasValue;
                                        var btnText = hasPo ? $"PO sent: {item.PO}" : (wasRequested ? "PO was requested" : "Request PO #");
                                        var btnClass = hasPo ? "btn btn-success btn-sm" : (wasRequested ? "btn btn-secondary btn-sm" : "btn btn-warning btn-sm");
                                        var disabledAttr = hasPo ? "disabled" : "";
                                    }
                                    <button type="submit" class="@btnClass" @disabledAttr>@btnText</button>
                                </form>

                                @if (showPackingSlip)
                                {
                                    <a class="btn btn-outline-primary btn-sm"
                                       href="@Url.Action("GeneratePackingSlip", "ToolingWorkOrder", new { groupID = item.GroupID, email = true })"
                                       target="_blank" rel="noopener">
                                        Create Packing Slip
                                    </a>
                                }
                                <a class="btn btn-success btn-sm"
                                   href="@Url.Action("CompleteWorkOrderModal", "ToolingWorkOrder", new { groupID = item.GroupID })"
                                   data-bs-toggle="modal" data-bs-target="#toolingWorkOrderModal">
                                    Complete Work Order
                                </a>


                            </td>
                        </tr>
                        <!-- Collapsible items row -->
                        <tr id="@rowId" class="d-none">
                            <td></td>
                            <td colspan="8">
                                <div class="p-2 border rounded bg-light" data-items-container="@item.GroupID">
                                    <div class="text-muted">Loading...</div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    <!-- ONLY: Add for Assembly -->
    <div class="d-flex gap-2 mb-3 align-items-center">
        <div class="input-group" style="max-width:420px">
            <span class="input-group-text">Assembly #</span>
            <input id="quickAssembly" type="text" class="form-control" placeholder="e.g., ASM-1001" />
            <button id="btnAddForAssembly" class="btn btn-primary" type="button">
                Add for Assembly
            </button>
        </div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <div class="input-group" style="max-width:420px">
            <span class="input-group-text">Search</span>
            <input id="invSearch" type="text" class="form-control" placeholder="Type to search any field..." />
        </div>

        <div class="ms-auto d-flex align-items-center gap-2">
            <label class="form-label mb-0" for="invPageSize">Rows per page</label>
            <select id="invPageSize" class="form-select form-select-sm" style="width: auto;">
                <option>10</option>
                <option selected>25</option>
                <option>50</option>
                <option>100</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <h3 class="mb-2">Tooling Inventory</h3>
        <table id="tblInventory" class="table table-striped table-bordered shadow-sm align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Id</th>
                    <th>Assembly #</th>
                    <th>Tool #</th>
                    <th>Tool Item</th>
                    <th>Condition</th>
                    <th>Status</th>
                    <th>Location</th>
                    <th>Unavailable Info</th>
                    <th style="width:90px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.AssemblyNumber</td>
                        <td>@t.ToolNumber</td>
                        <td>@t.ToolItem</td>
                        <td>@t.Condition</td>
                        <td>@t.Status</td>
                        <td>@t.Location</td>
                        <td>
                            @if (t.Status == ToolStatus.Unavailable)
                            {
                                <div>
                                    <div><strong>Reason:</strong> @t.UnavailableReason</div>
                                    <div><strong>Since:</strong> @(t.DateUnavailable?.ToShortDateString() ?? "-")</div>
                                    <div><strong>ETA:</strong> @(t.EstimatedAvailableDate?.ToShortDateString() ?? "-")</div>
                                </div>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary js-edit" data-id="@t.Id">Edit</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mt-2">
        <div id="invPageInfo" class="text-muted small"></div>
        <nav>
            <ul id="invPager" class="pagination pagination-sm mb-0"></ul>
        </nav>
    </div>


<!-- Reusable modal -->
<div class="modal fade" id="toolModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toolModalTitle">Tool Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="toolModalBody"></div>
        </div>
    </div>
</div>


    <div class="modal fade" id="toolingWorkOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xxl modal-dialog-scrollable">
            <div class="modal-content"></div>
        </div>
    </div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <!-- Hidden anti-forgery so JS can grab a token even if no visible form -->
        <form id="__afForm" class="d-none">@Html.AntiForgeryToken()</form>

        <script>
            function getPageAntiforgeryToken() {
              const input = document.querySelector('#__afForm input[name="__RequestVerificationToken"]');
              return input ? input.value : '';
            }

            async function swalConfirmDelete(title='Delete this?', text='This cannot be undone.') {
              const r = await Swal.fire({
                title, text, icon:'warning',
                showCancelButton:true, confirmButtonText:'Delete', cancelButtonText:'Cancel',
                reverseButtons:true, focusCancel:true
              });
              return r.isConfirmed;
            }
        </script>

    <script>
        (function () {
          const modalEl = document.getElementById('toolModal');
          const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
          const body = document.getElementById('toolModalBody');
          const title = document.getElementById('toolModalTitle');
          const mainAsmInput = document.getElementById('quickAssembly');

          // Open CREATE (prefilled if main input has value)
          document.getElementById('btnAddForAssembly').addEventListener('click', async () => {
            const asm = (mainAsmInput?.value || '').trim();
            title.textContent = asm ? ('Add Tool — ' + asm) : 'Add Tool';
            const url = asm
              ? '@Url.Action("Create", "ToolingInventory")?assembly=' + encodeURIComponent(asm)
              : '@Url.Action("Create", "ToolingInventory")';
            await loadPartial(url);
            modal.show();
            body.querySelector('input[name="ToolNumber"]')?.focus();
          });

          // Open EDIT
          document.querySelectorAll('.js-edit').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              title.textContent = 'Edit Tool';
              await loadPartial('@Url.Action("Edit", "ToolingInventory")?id=' + encodeURIComponent(id));
              modal.show();
            });
          });

          async function loadPartial(url) {
                        const r = await fetch(url, {
              credentials: 'same-origin',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!r.ok) { console.error('loadPartial failed', r.status); return; }
            body.innerHTML = await r.text();
            initDynamicBits();
          }

          // Delegated submit for Create + Edit
          body.addEventListener('submit', async (e) => {
            const form = e.target.closest('#toolItemForm');
            if (!form) return;
            e.preventDefault();

            // capture which button was clicked (mode)
            const submitter = e.submitter || document.activeElement;

            const fd = new FormData(form);
            if (submitter && submitter.name) {
              fd.append(submitter.name, submitter.value); // mode=add_more | add_clear
            }

            const r = await fetch(form.action, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              body: fd
            });

            let data = null, isJson = false;
            try { data = await r.clone().json(); isJson = true; } catch {}

            if (isJson && data && data.ok) {
              // clear main page Assembly only when not add_more
              if (data.mode !== 'add_more' && mainAsmInput) mainAsmInput.value = '';

              if (data.mode === 'add_clear') {
                return swalOK(data.message, () => {
                  modal.hide();
                  location.reload();
                });
              }

              if (data.mode === 'add_more') {
                swalOK(data.message);
                const asm = (data.assembly || '').toString();
                const url = '@Url.Action("Create", "ToolingInventory")' + (asm ? ('?assembly=' + encodeURIComponent(asm)) : '');
                await loadPartial(url);
                title.textContent = asm ? ('Add Tool — ' + asm) : 'Add Tool';
                modal.show();
                const toolInput = body.querySelector('input[name="ToolNumber"]');
                toolInput?.focus(); toolInput?.select?.();
                return;
              }

              // EDIT path (no mode)
              return swalOK('Saved changes.', () => {
                modal.hide();
                location.reload();
              });
            }

            // Not JSON -> validation HTML
            const html = await r.text();
            body.innerHTML = html;
            initDynamicBits();
          });

          // Unavailable toggle
          body.addEventListener('change', (e) => {
            const select = e.target.closest('select[name="Status"]');
            if (!select) return;
            const form = select.closest('#toolItemForm');
            const box = form?.querySelector('[data-box="unavail"]');
            if (!box) return;
            const v = parseInt(select.value || '1', 10);
            box.style.display = (v === 2) ? '' : 'none'; // assumes Unavailable === 2
          });

          function initDynamicBits() {
            const form = body.querySelector('#toolItemForm');
            if (!form) return;
            const status = form.querySelector('[name="Status"]');
            const box = form.querySelector('[data-box="unavail"]');
            if (status && box) {
              const v = parseInt(status.value || '1', 10);
              box.style.display = (v === 2) ? '' : 'none';
            }
            // prevent submit buttons from dismissing the modal
            form.querySelectorAll('button[type="submit"]').forEach(b => b.removeAttribute('data-bs-dismiss'));
          }

          function swalOK(message, onClose) {
            if (window.Swal) {
              Swal.fire({ icon: 'success', title: 'Success', text: message, confirmButtonText: 'OK' })
                .then(() => { if (typeof onClose === 'function') onClose(); });
            } else {
              alert(message);
              if (typeof onClose === 'function') onClose();
            }
          }

                      if (!window._invEditDeleteWired) {
              document.getElementById('toolModal')?.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-action="delete-inventory-item"]');
                if (!btn) return;

                e.preventDefault();

                const id = btn.dataset.id;
                const url = btn.dataset.url || '/ToolingInventory/Delete';

                if (!id) {
                  await Swal.fire({ icon:'error', title:'Missing ID', text:'Could not determine the Tool Item ID.' });
                  return;
                }

                const ok = await swalConfirmDelete('Delete this Tool Item?', 'This cannot be undone.');
                if (!ok) return;

                await Swal.fire({
                  title: 'Deleting…',
                  allowOutsideClick: false,
                  allowEscapeKey: false,
                  didOpen: () => Swal.showLoading()
                });

                const token = getPageAntiforgeryToken();
                const fd = new FormData();
                fd.append('__RequestVerificationToken', token);
                fd.append('id', id);

                try {
                  const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                      'X-Requested-With': 'XMLHttpRequest',
                      'RequestVerificationToken': token
                    },
                    body: fd,
                    credentials: 'same-origin'
                  });

                  // Accept either JSON {ok:true} or a redirect/empty
                  let okJson = false, json = null;
                  try { json = await res.clone().json(); okJson = true; } catch {}

                  if (okJson && json && json.ok) {
                    await Swal.fire({ icon:'success', title:'Deleted', timer: 1200, showConfirmButton:false });
                    bootstrap.Modal.getOrCreateInstance(document.getElementById('toolModal')).hide();
                    location.reload();
                    return;
                  }

                  if (!res.ok) {
                    const t = await res.text().catch(()=>res.statusText);
                    await Swal.fire({ icon:'error', title:'Delete failed', html:`<pre style="text-align:left;white-space:pre-wrap">${(t || res.statusText).slice(0,600)}</pre>` });
                    return;
                  }

                  // Fallback success
                  await Swal.fire({ icon:'success', title:'Deleted', timer: 1200, showConfirmButton:false });
                  bootstrap.Modal.getOrCreateInstance(document.getElementById('toolModal')).hide();
                  location.reload();
                } catch (err) {
                  await Swal.fire({ icon:'error', title:'Network error', text: err?.message || 'Unexpected error' });
                }
              });

              window._invEditDeleteWired = true;
            }
        })();
    </script>
    <script>
                   document.addEventListener('click', async (e) => {
                  const a = e.target.closest('a[data-bs-target="#toolingWorkOrderModal"]');
              if (!a) return;
              e.preventDefault();
              const url = a.getAttribute('href');

                         const r = await fetch(url, {
              credentials: 'same-origin',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const html = await r.text();
            document.querySelector('#toolingWorkOrderModal .modal-content').innerHTML = html;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('toolingWorkOrderModal')).show();


                  const modalEl = document.getElementById('toolingWorkOrderModal');
              modalEl.querySelector('.modal-content').innerHTML = html;   // inject fragment
              bootstrap.Modal.getOrCreateInstance(modalEl).show();
            });



        // Expand/collapse + lazy-load tool items
        document.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-action="toggle-items"]');
          if (!btn) return;
          const group = btn.dataset.group;
          const row = document.getElementById(`row-items-${group}`);
          const icon = btn.querySelector('i');

          const expanded = btn.getAttribute('aria-expanded') === 'true';
          if (expanded) {
            btn.setAttribute('aria-expanded', 'false');
            row?.classList.add('d-none');
            icon?.classList.remove('rotate-90');
            return;
          }

          btn.setAttribute('aria-expanded', 'true');
          row?.classList.remove('d-none');
          icon?.classList.add('rotate-90');

          const container = row?.querySelector(`[data-items-container="${group}"]`);
          if (!container) return;
          if (container.dataset.loaded === '1') return;

          try {
                const url = '@Url.Action("ItemsTable", "ToolingWorkOrder")' + '?groupID=' + encodeURIComponent(group);
                       const res = await fetch(url, {
              credentials: 'same-origin',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const html = await res.text();

            container.innerHTML = html;
            container.dataset.loaded = '1';
          } catch (err) {
            container.innerHTML = `<div class="text-danger">Failed to load items: ${err?.message || 'Unknown error'}</div>`;
          }
        });

      
    </script>
        <script>
            document.addEventListener('submit', async (e) => {
              const form = e.target.closest('.request-po-form');
              if (!form) return;
              e.preventDefault();

              const btn = form.querySelector('button[type="submit"]');
              const prevDisabled = btn?.disabled; if (btn) btn.disabled = true;

              try {
                const res = await fetch(form.action, {
                  method: 'POST',
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': getPageAntiforgeryToken()
                  },
                  body: new FormData(form),
                  credentials: 'same-origin'
                });

                const payload = await res.json().catch(() => ({}));
                if (!res.ok || !payload.ok) {
                  await Swal.fire({ icon:'error', title:'PO request failed', text: payload.error || 'Unknown error' });
                  return;
                }

                await Swal.fire({ icon:'success', title:'Sent', text:'PO request email sent.' });
                location.reload();
              } catch (err) {
                await Swal.fire({ icon:'error', title:'PO request failed', text: err?.message || 'Network error' });
              } finally {
                if (btn) btn.disabled = prevDisabled ?? false;
              }
            });
        </script>

        <script>
            (function () {
              const table = document.getElementById('tblInventory');
              if (!table) return;

              const tbody = table.querySelector('tbody');
              const rows = Array.from(tbody.querySelectorAll('tr'));
              const searchInput = document.getElementById('invSearch');
              const pageSizeSel = document.getElementById('invPageSize');
              const pager = document.getElementById('invPager');
              const pageInfo = document.getElementById('invPageInfo');

              let currentPage = 1;
              let pageSize = parseInt(pageSizeSel?.value || '25', 10);
              let filtered = rows;

              function normalize(s) { return (s || '').toString().toLowerCase(); }

              function applyFilter() {
                const q = normalize(searchInput?.value || '');
                if (!q) {
                  filtered = rows;
                } else {
                  filtered = rows.filter(tr => normalize(tr.innerText).includes(q));
                }
                currentPage = 1;
                render();
              }

              function getPageCount() {
                return Math.max(1, Math.ceil(filtered.length / pageSize));
              }

              function render() {
                // hide all rows first
                rows.forEach(tr => tr.style.display = 'none');

                // compute slice for current page
                const totalPages = getPageCount();
                if (currentPage > totalPages) currentPage = totalPages;

                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = startIdx + pageSize;

                const pageRows = filtered.slice(startIdx, endIdx);
                pageRows.forEach(tr => tr.style.display = '');

                // page info
                const from = filtered.length ? startIdx + 1 : 0;
                const to = Math.min(endIdx, filtered.length);
                pageInfo.textContent = `Showing ${from}-${to} of ${filtered.length} record(s)`;

                // pager UI
                renderPager(totalPages);
              }

              function renderPager(totalPages) {
                pager.innerHTML = '';
                const ul = pager;

                function addItem(label, page, disabled = false, active = false) {
                  const li = document.createElement('li');
                  li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
                  const a = document.createElement('a');
                  a.className = 'page-link';
                  a.href = '#';
                  a.textContent = label;
                  if (!disabled && !active) {
                    a.addEventListener('click', (e) => { e.preventDefault(); currentPage = page; render(); });
                  }
                  li.appendChild(a);
                  ul.appendChild(li);
                }

                // Prev
                addItem('‹', Math.max(1, currentPage - 1), currentPage === 1, false);

                // Page numbers (compact: show first, last, and window around current)
                const windowSize = 2;
                const pages = [];
                for (let p = 1; p <= totalPages; p++) {
                  if (p === 1 || p === totalPages || (p >= currentPage - windowSize && p <= currentPage + windowSize)) {
                    pages.push(p);
                  }
                }
                // fill gaps with ellipses
                let prev = 0;
                pages.forEach(p => {
                  if (p - prev > 1) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">…</span>';
                    ul.appendChild(li);
                  }
                  addItem(String(p), p, false, p === currentPage);
                  prev = p;
                });

                // Next
                addItem('›', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false);
              }

              // debounce search
              let t = null;
              searchInput?.addEventListener('input', () => {
                clearTimeout(t);
                t = setTimeout(applyFilter, 150);
              });

              pageSizeSel?.addEventListener('change', () => {
                pageSize = parseInt(pageSizeSel.value, 10) || 25;
                currentPage = 1;
                render();
              });

              // initial render
              render();

              // If rows are added dynamically in the future, call applyFilter() again.
            })();
        </script>
        <script>
                      if (!window._twModalSubmitWired) {
              document.getElementById('toolingWorkOrderModal')?.addEventListener('submit', async (e) => {
                const form = e.target;
                if (!form || !['toolWorkOrderForm','addItemForm','saveAllForm','completeWorkOrderForm'].includes(form.id)) return;


                e.preventDefault();

                const btn = form.querySelector('[type="submit"]');
                const prevHtml = btn?.innerHTML;
                if (btn) { btn.disabled = true; btn.innerHTML = 'Saving...'; }

                try {
                  const res = await fetch(form.action, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: new FormData(form)
                  });

                  const ct = res.headers.get('content-type') || '';

                  if (form.id === 'toolWorkOrderForm') {
                    if (ct.includes('application/json')) {
                      const data = await res.json();
                                  // after const data = await res.json();
                       if (data.ok) {
              const swalTitle = data.title || 'Success';
              const swalHtml =
                typeof data.html === 'string' && data.html.length
                  ? data.html
                  : (data.message ? `<p>${data.message}</p>` : '');

              await Swal.fire({
                icon: 'success',
                title: swalTitle,
                html: swalHtml,
                confirmButtonText: 'OK'
              });

              bootstrap.Modal.getOrCreateInstance(document.getElementById('toolingWorkOrderModal')).hide();
              location.reload();
              return;
            }


                      await Swal.fire({ icon:'error', title:'Save failed', text: data.error || 'Could not save.' });
                      return;
                    }
                    const html = await res.text();
                    document.querySelector('#toolingWorkOrderModal .modal-content').innerHTML = html;
                    await Swal.fire({ icon:'warning', title:'Validation', text:'Please fix the highlighted errors.' });
                    return;
                  }

                  if (ct.includes('text/html')) {
                    const html = await res.text();
                    document.querySelector('#toolingWorkOrderModal .modal-content').innerHTML = html;
                    if (res.ok) {
                      if (form.id === 'addItemForm') await Swal.fire({ icon:'success', title:'Added', text:'Tool item added.' });
                      if (form.id === 'saveAllForm') await Swal.fire({ icon:'success', title:'Saved', text:'All tool items saved.' });
                    }
                    return;
                  }

                  if (!res.ok) {
                    const t = await res.text().catch(()=>res.statusText);
                    await Swal.fire({ icon:'error', title:'Action failed', text:(t||res.statusText).slice(0,600) });
                    return;
                  }
                  const html = await res.text();
                  document.querySelector('#toolingWorkOrderModal .modal-content').innerHTML = html;

                } catch (err) {
                  await Swal.fire({ icon:'error', title:'Error', text: err?.message || 'Unexpected error.' });
                } finally {
                  if (btn) { btn.disabled = false; btn.innerHTML = prevHtml; }
                }
              });
              window._twModalSubmitWired = true;
            }

        </script>
        <script>
            if (!window._invInlineDeleteWired) {
              document.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-action="delete-tool-item"]');
                if (!btn) return;

                e.preventDefault();

                // Find row + ids
                const row = btn.closest('tr');
                const id = row?.dataset?.itemId || row?.querySelector('input[name$=".Id"]')?.value;
                // groupID can be on row or in the expando container id
                let groupID = row?.dataset?.groupId
                           || row?.querySelector('input[name$=".GroupID"]')?.value;

                if (!groupID) {
                  // try to infer from container attribute used in your page
                  const container = btn.closest('[data-items-container]');
                  groupID = container?.getAttribute('data-items-container') || '';
                }

                if (!id || !groupID) {
                  await Swal.fire({ icon:'error', title:'Missing info', text:'Could not determine item/group to delete.' });
                  return;
                }

                const ok = await swalConfirmDelete('Delete this tool item?', 'This cannot be undone.');
                if (!ok) return;

                // Show loading
                await Swal.fire({
                  title: 'Deleting…',
                  allowOutsideClick: false,
                  allowEscapeKey: false,
                  didOpen: () => Swal.showLoading()
                });

                const token = getPageAntiforgeryToken();
                const form = new FormData();
                form.append('__RequestVerificationToken', token);
                form.append('id', id);
                form.append('groupID', groupID);

                try {
                  const res = await fetch('/ToolingWorkOrder/DeleteToolItemAjax', {
                    method: 'POST',
                    headers: {
                      'X-Requested-With': 'XMLHttpRequest',
                      'RequestVerificationToken': token
                    },
                    body: form,
                    credentials: 'same-origin'
                  });

                  const payload = await res.text();

                  if (!res.ok) {
                    await Swal.fire({ icon:'error', title:'Delete failed', html:`<pre style="text-align:left;white-space:pre-wrap">${(payload || res.statusText).slice(0,600)}</pre>` });
                    return;
                  }

                  // Refresh just the inline table for this group
                  const container = document.querySelector(`[data-items-container="${groupID}"]`) || btn.closest('[data-items-container]');
                  if (container) container.innerHTML = payload;

                  await Swal.fire({ icon:'success', title:'Deleted', timer: 1200, showConfirmButton:false });
                } catch (err) {
                  await Swal.fire({ icon:'error', title:'Network error', text: err?.message || 'Unexpected error' });
                }
              });

              window._invInlineDeleteWired = true;
            }
        </script>


    <style>
        .rotate-90 {
            transform: rotate(90deg);
            transition: transform .15s ease;
        }
    </style>
        <style>
            #toolingWorkOrderModal .modal-dialog {
                max-width: 95vw;
                width: 95vw;
            }

            #toolingWorkOrderModal .modal-body {
                max-height: 80vh;
                overflow: auto;
            }
        </style>
        <style>
            /* Hide *any* delete buttons that may be rendered by shared partials */
            [data-action="delete-tool-item"],
            [data-action="delete-inventory-item"] {
                display: none !important;
            }
        </style>

}
