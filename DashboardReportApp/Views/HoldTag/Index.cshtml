@model DashboardReportApp.Models.HoldTagIndexViewModel
@using System.Text.Json
@{
    var isAdmin = (ViewBag.IsAdmin as bool?) ?? false;
}

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>


<style>
    #imageModal .modal-dialog {
        max-width: 95% !important;
    }

    #imageModal .modal-body {
        padding: 0;
        background-color: #000;
    }

    /* Open / not completed hold tags (BRIGHTER) */
    tr.ht-open > td,
    tr.ht-detail-row.ht-open > td,
    tr.child.ht-open > td {
        background-color: #ffeb3b !important; /* brighter yellow */
    }



    /* NEW: make table more vertical / wrapped */
    #holdTagTable {
        table-layout: fixed; /* force columns to respect width */
        width: 100%;
        font-size: 0.8rem; /* slightly smaller text */
    }

        #holdTagTable th,
        #holdTagTable td {
            white-space: normal; /* allow wrapping */
            word-wrap: break-word;
            vertical-align: top;
        }

            /* Narrow, code-like columns */
            #holdTagTable th:nth-child(1),
            #holdTagTable td:nth-child(1), /* ID */
            #holdTagTable th:nth-child(6),
            #holdTagTable td:nth-child(6), /* Lot # */
            #holdTagTable th:nth-child(15),
            #holdTagTable td:nth-child(15), /* Hold Tags */
            #holdTagTable th:nth-child(16),
            #holdTagTable td:nth-child(16), /* Qty On Hold */
            #holdTagTable th:nth-child(17),
            #holdTagTable td:nth-child(17), /* Unit */
            #holdTagTable th:nth-child(18),
            #holdTagTable td:nth-child(18) { /* Pcs Scrapped */
                max-width: 40px;
            }

            /* Medium text columns */

            #holdTagTable th:nth-child(2),
            #holdTagTable td:nth-child(2), /* Prod # */
            #holdTagTable th:nth-child(3),
            #holdTagTable td:nth-child(3), /* Run # */
            #holdTagTable th:nth-child(4),
            #holdTagTable td:nth-child(4), /* Part */
            #holdTagTable th:nth-child(5),
            #holdTagTable td:nth-child(5), /* Component */
            #holdTagTable th:nth-child(7),
            #holdTagTable td:nth-child(7), /* Material */
            #holdTagTable th:nth-child(9),
            #holdTagTable td:nth-child(9), /* Date */
            #holdTagTable th:nth-child(10),
            #holdTagTable td:nth-child(10), /* Issued By */
            #holdTagTable th:nth-child(11),
            #holdTagTable td:nth-child(11), /* Disposition */
            #holdTagTable th:nth-child(12),
            #holdTagTable td:nth-child(12), /* Disposition By */
            #holdTagTable th:nth-child(19),
            #holdTagTable td:nth-child(19), /* Date Completed */
            #holdTagTable th:nth-child(20),
            #holdTagTable td:nth-child(20), /* File 1 */
            #holdTagTable th:nth-child(21),
            #holdTagTable td:nth-child(21), /* File 2 */
            #holdTagTable th:nth-child(22),
            #holdTagTable td:nth-child(22) { /* Actions */
                max-width: 100px;
            }

            /* Long text columns – allow bigger width but still wrap */
            #holdTagTable th:nth-child(8),
            #holdTagTable td:nth-child(8), /* Discrepancy */
            #holdTagTable th:nth-child(13),
            #holdTagTable td:nth-child(13) { /* Rework Instructions */
                max-width: 100px;
            }

    /* Wrapper can scroll a bit if it still overflows */
    #holdTagTable_wrapper {
        overflow-x: auto;
    }
</style>
<style>
    /* child/detail row styling */
    tr.ht-detail-row td {
        padding: 0.5rem 0.75rem !important;
        background: rgba(0,0,0,0.03);
    }

    .ht-detail {
        font-size: 0.85rem;
        line-height: 1.2rem;
    }

        .ht-detail .label {
            font-weight: 600;
            margin-right: 0.25rem;
        }

        .ht-detail .muted {
            opacity: 0.85;
        }
</style>

<h1 class="text-center mb-4">Hold Tag</h1>

<!-- NEW: Add Request Button -->
<div class="text-center mb-4">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRequestModal">
        Add Request
    </button>
</div>

<div class="container-fluid px-3 mt-4">
    <!-- Instructional Message -->
    <div class="row justify-content-center">
        <h8 class="text-center mb-4">You can upload pictures from your phone by connecting to wifi then viewing this page on your phone.</h8>
    </div>

    <!-- QR Codes and Immediate Assistance Card in one row -->
    <div class="d-flex justify-content-evenly align-items-center mb-4 flex-wrap">
        <!-- Wi‑Fi QR Code -->
        <div class="text-center mb-3">
            <canvas id="wifi-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">Connect to Wifi</div>
        </div>

        <!-- Immediate Assistance Card -->
        <div class="card shadow mb-3" style="max-width: 300px;">
            <div class="card-body p-2">
                <p class="text-center mb-2" style="font-size: 0.9rem;">
                    For immediate assistance, call/text until you get an answer:
                </p>
                <ul class="list-group" style="font-size: 0.8rem;">
                    <li class="list-group-item p-1">Tom Grieneisen 814-591-2704</li>
                    <li class="list-group-item p-1">Chico Almendarez 814-541-1181</li>
                    <li class="list-group-item p-1">Anthony Meholick 814-591-4074</li>
                    <li class="list-group-item p-1">Roger Jones 814-939-9412</li>
                </ul>
            </div>
        </div>

        <!-- Current Page QR Code -->
        <div class="text-center mb-3">
            <canvas id="current-page-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">View on your device</div>
        </div>
    </div>
</div>

<!-- READ-ONLY TABLE OF HOLD TAG RECORDS -->
<div class="container-fluid px-3 mt-4">
    <h2 class="text-center mb-4">Hold Tag Records</h2>
    <!-- Filters for the table -->
    <div class="row mb-3 justify-content-center">
        <div class="col-auto">
            <input type="text" id="recordSearchInput" class="form-control" placeholder="Search records..." style="max-width: 200px;" />
        </div>
        <div class="col-auto d-flex">
            <input type="date" id="recordStartDate" class="form-control me-2" style="max-width: 150px;" />
            <input type="date" id="recordEndDate" class="form-control" style="max-width: 150px;" />
        </div>
        <div class="col-auto">
            <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="holdTagTable" class="table table-striped table-bordered shadow-sm custom-table" style="width:100%; border-collapse:collapse;">
            <thead class="table-dark">
                <tr>
                    <th style="width: 3%;">ID</th>
                    <th style="width: 7%;">Production #</th>
                    <th style="width: 7%;">Run #</th>
                    <th style="width: 7%;">Part</th>
                    <th style="width: 7%;">Component</th>
                    <th style="width: 7%;">Lot #</th>
                    <th style="width: 7%;">Material</th>
                    <th style="width: 6%;">Stage</th>

                    <th style="width: 4%;">Skid #</th>
                    <th style="width: 6%;">Qty On Hold</th>
                    <th style="width: 6%;">Unit</th>
                    <th style="width: 7%;">Date</th>
                    <th style="width: 8%;">Actions</th>
                </tr>
            </thead>



            <tbody>
                @foreach (var record in Model.Records)
                {
                    <tr class="ht-main"
                        data-issuedby="@record.IssuedBy"
                        data-discrepancy="@record.Discrepancy"
                        data-disposition="@record.Disposition"
                        data-dispositionby="@record.DispositionBy"
                        data-reworkinstr="@record.ReworkInstr"
                        data-reworkinstrby="@record.ReworkInstrBy"
                        data-qtytags="@(record.Quantity?.ToString() ?? "")"
                        data-qtyonhold="@(record.QuantityOnHold?.ToString() ?? "")"
                        data-unit="@record.Unit"
                        data-pcsscrapped="@(record.PcsScrapped?.ToString() ?? "")"
                        data-datecompleted="@(record.DateCompleted?.ToString("yyyy-MM-dd") ?? "")"
                        data-file1="@record.FileAddress1"
                        data-file2="@record.FileAddress2"
                        data-source="@record.Source"
                        data-stage="@record.Stage">


                        <td>@record.Id</td>
                        <td>@record.ProdNumber</td>
                        <td>@record.RunNumber</td>
                        <td>@record.Part</td>
                        <td>@record.Component</td>
                        <td>@record.LotNumber</td>
                        <td>@record.MaterialCode</td>
                        <td>
                            @{
                                // Prefer Stage (what the user selected). Fallback to Source mapping for old records.
                                var stg = (record.Stage ?? "").ToLower();
                                var src = (record.Source ?? "").ToLower();

                                string stageText =
                                !string.IsNullOrWhiteSpace(stg) ? stg :
                                (src == "pressrun" ? "green" :
                                src == "sinterrun" ? "sintered" :
                                src);

                                // Pretty label
                                string label =
                                stageText == "green" ? "Green" :
                                stageText == "sintered" ? "Sintered" :
                                stageText == "greenassembly" ? "Green Assembly" :
                                stageText == "machined" ? "Machined" :
                                stageText == "plated" ? "Plated" :
                                stageText == "heattreated" ? "Heat Treated" :
                                stageText == "annealed" ? "Annealed" :
                                stageText == "sized" ? "Sized" :
                                stageText;

                                @label
                            }
                        </td>


                        <td>@(record.SkidNumber > 0 ? record.SkidNumber.ToString() : "")</td>
                        <td>@record.QuantityOnHold</td>
                        <td>@(string.IsNullOrWhiteSpace(record.Unit) ? "" : record.Unit + "(s)")</td>
                        <td>@(record.Date?.ToString("yyyy-MM-dd") ?? "")</td>

                        <td>
                            @* Keep your existing buttons *@
                            @if (!isAdmin)
                            {
                                <button type="button"
                                        class="btn btn-secondary btn-sm add-file-btn"
                                        data-id="@record.Id">
                                    Add / Update File1
                                </button>
                            }

                            @if (isAdmin)
                            {
                                <button type="button"
                                        class="btn btn-primary btn-sm edit-btn"
                                        data-id="@record.Id"
                                        data-part="@record.Part"
                                        data-component="@record.Component"
                                        data-discrepancy="@record.Discrepancy"
                                        data-date="@(record.Date?.ToString("yyyy-MM-dd") ?? "")"
                                        data-issuedby="@record.IssuedBy"
                                        data-disposition="@record.Disposition"
                                        data-dispositionby="@record.DispositionBy"
                                        data-reworkinstr="@record.ReworkInstr"
                                        data-reworkinstrby="@record.ReworkInstrBy"
                                        data-quantity="@record.Quantity"
                                        data-quantityonhold="@record.QuantityOnHold"
                                        data-lotnumber="@record.LotNumber"
                                        data-materialcode="@record.MaterialCode"
                                        data-runnumber="@record.RunNumber"
                                        data-unit="@record.Unit"
                                        data-pcsscrapped="@(record.PcsScrapped?.ToString() ?? "")"
                                        data-datecompleted="@(record.DateCompleted?.ToString("yyyy-MM-dd") ?? "")"
                                        data-fileaddress1="@record.FileAddress1"
                                        data-fileaddress2="@record.FileAddress2"
                                        data-prodnumber="@record.ProdNumber"
                                        data-source="@record.Source"
                                        data-stage="@record.Stage"
                                        data-skidnumber="@record.SkidNumber">
                                    Edit
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>



        </table>
    </div>
</div>

<!-- Modal for "Add Request" -->
<div class="modal fade" id="addRequestModal" tabindex="-1" aria-labelledby="addRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRequestModalLabel">Add Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form asp-action="Submit" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="modal-body">

                    <!-- ✅ Row 1: Run + Prod (TOP) -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ModalRunNumber" class="form-label">Run Number</label>
                            <input type="text" id="ModalRunNumber" name="RunNumber" class="form-control" autocomplete="off" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ModalProdNumber" class="form-label">Production Number</label>
                            <input type="text" id="ModalProdNumber" name="ProdNumber" class="form-control" autocomplete="off" />
                            <span asp-validation-for="FormModel.ProdNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- ✅ Row 2: Part + Component -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ModalPart" class="form-label">Part</label>
                            <input type="text" id="ModalPart" name="Part" class="form-control" readonly />
                            <span asp-validation-for="FormModel.Part" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ModalComponent" class="form-label">Component</label>
                            <input type="text" id="ModalComponent" name="Component" class="form-control" readonly />
                        </div>
                    </div>

                    <!-- ✅ Row 3: Material + Lot -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ModalMaterialCode" class="form-label">Material Code</label>
                            <input type="text" id="ModalMaterialCode" name="MaterialCode" class="form-control" readonly />
                            <span asp-validation-for="FormModel.MaterialCode" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ModalLotNumber" class="form-label">Lot Number</label>
                            <input type="text" id="ModalLotNumber" name="LotNumber" class="form-control" readonly />
                            <span asp-validation-for="FormModel.LotNumber" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- ✅ Row 4: Stage + Skid -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ModalStage" class="form-label">Stage</label>
                            <select id="ModalStage" name="Stage" class="form-control" required>
                                <option value="">-- Select Stage --</option>
                                <option value="green">Green</option>
                                <option value="sintered">Sintered</option>

                                <!-- Future (no logic yet) -->
                                <option value="greenassembly">Green Assembly</option>
                                <option value="machined">Machined</option>
                                <option value="plated">Plated</option>
                                <option value="heattreated">Heat Treated</option>
                                <option value="annealed">Annealed</option>
                                <option value="sized">Sized</option>
                            </select>
                            <small class="text-muted">Green → Press Run. Sintered → Sinter Run.</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ModalSkidNumber" class="form-label">Skid Number</label>
                            <input type="number" id="ModalSkidNumber" name="SkidNumber" class="form-control" min="0" value="0" />
                            <small class="text-muted">Auto-fills from the Place On Hold button. You can change it.</small>
                        </div>
                    </div>

                    <!-- Hidden inferred source -->
                    <input type="hidden" id="ModalSource" name="Source" value="" />


                    <!-- ✅ Row 5: Operator + Qty Hold Tags + Qty On Hold -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="ModalIssuedBy" class="form-label">Operator</label>
                            <select id="ModalIssuedBy" name="IssuedBy" class="form-control" required>
                                <option value="">-- Select --</option>
                                @if (ViewData["Operators"] is List<string> opList1)
                                {
                                    foreach (var op in opList1)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="FormModel.IssuedBy" class="text-danger"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="ModalQuantity" class="form-label">Hold Tags</label>
                            <input type="number" id="ModalQuantity" name="Quantity" class="form-control" required />
                            <span asp-validation-for="FormModel.Quantity" class="text-danger"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="ModalQuantityOnHold" class="form-label">Qty On Hold</label>
                            <input type="number" id="ModalQuantityOnHold" name="QuantityOnHold" class="form-control" required />
                            <span asp-validation-for="FormModel.QuantityOnHold" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- ✅ Row 6: Unit + Attachment -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ModalUnit" class="form-label">Unit</label>
                            <select id="ModalUnit" name="Unit" class="form-control">
                                <option value="skid" data-singular="skid" data-plural="skids">Skid</option>
                                <option value="tray" data-singular="tray" data-plural="trays">Tray</option>
                                <option value="tote" data-singular="tote" data-plural="totes">Tote</option>
                                <option value="barrel" data-singular="barrel" data-plural="barrels">Barrel</option>
                                <option value="pc" data-singular="pc" data-plural="pcs">Pc</option>
                            </select>
                            <span asp-validation-for="FormModel.Unit" class="text-danger"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="ModalFile" class="form-label">Attachment (Optional)</label>
                            <input type="file" name="file" id="ModalFile" class="form-control" />
                        </div>
                    </div>

                    <!-- Discrepancy stays below (was required) -->
                    <div class="mb-3">
                        <label for="ModalDiscrepancy" class="form-label">Discrepancy</label>
                        <textarea id="ModalDiscrepancy" name="Discrepancy" class="form-control text-area-large" required></textarea>
                        <span asp-validation-for="FormModel.Discrepancy" class="text-danger"></span>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
@if (isAdmin)
{
    <!-- Admin: Edit Record Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="HoldTag" asp-action="UpdateRequest" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <input type="hidden" name="Id" id="edit-id" />

                        <!-- ✅ Row 1: Run + Prod (TOP) -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-runnumber" class="form-label">Run Number</label>
                                <input type="text" name="RunNumber" id="edit-runnumber" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="edit-prodnumber" class="form-label">Production Number</label>
                                <input type="text" name="ProdNumber" id="edit-prodnumber" class="form-control" />
                            </div>
                        </div>

                        <!-- ✅ Row 2: Part + Component -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-part" class="form-label">Part</label>
                                <input type="text" name="Part" id="edit-part" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="edit-component" class="form-label">Component</label>
                                <input type="text" name="Component" id="edit-component" class="form-control" />
                            </div>
                        </div>

                        <!-- ✅ Row 3: Material + Lot -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-materialcode" class="form-label">Material Code</label>
                                <input type="text" name="MaterialCode" id="edit-materialcode" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="edit-lotnumber" class="form-label">Lot Number</label>
                                <input type="text" name="LotNumber" id="edit-lotnumber" class="form-control" />
                            </div>
                        </div>

                        <!-- ✅ Row 4: Source + Skid -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-stage" class="form-label">Stage</label>
                                <select id="edit-stage" name="Stage" class="form-control" required>
                                    <option value="">-- Select Stage --</option>
                                    <option value="green">Green</option>
                                    <option value="sintered">Sintered</option>

                                    <!-- Future (no logic yet) -->
                                    <option value="greenassembly">Green Assembly</option>
                                    <option value="machined">Machined</option>
                                    <option value="plated">Plated</option>
                                    <option value="heattreated">Heat Treated</option>
                                    <option value="annealed">Annealed</option>
                                    <option value="sized">Sized</option>
                                </select>
                                <small class="text-muted">Green → Press Run. Sintered → Sinter Run.</small>

                                <!-- Hidden inferred source that actually posts -->
                                <input type="hidden" name="Source" id="edit-source" value="" />
                            </div>



                            <div class="col-md-6 mb-3">
                                <label for="edit-skidnumber" class="form-label">Skid Number</label>
                                <input type="number" name="SkidNumber" id="edit-skidnumber" class="form-control" min="0" value="0" />
                            </div>
                        </div>

                        <!-- ✅ Row 5: Operator + Hold Tags + Qty On Hold -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit-issuedby" class="form-label">Operator</label>
                                <select name="IssuedBy" id="edit-issuedby" class="form-control">
                                    <option value="">-- Select Operator --</option>
                                    @if (ViewBag.IssuedByOperators != null)
                                    {
                                        foreach (var op in (List<string>)ViewBag.IssuedByOperators)
                                        {
                                            <option value="@op">@op</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="edit-quantity" class="form-label">Hold Tags</label>
                                <input type="number" name="Quantity" id="edit-quantity" class="form-control" />
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="edit-quantityonhold" class="form-label">Qty On Hold</label>
                                <input type="number" name="QuantityOnHold" id="edit-quantityonhold" class="form-control" />
                            </div>
                        </div>

                        <!-- ✅ Row 6: Unit + Pcs Scrapped -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-unit" class="form-label">Unit</label>
                                <input type="text" name="Unit" id="edit-unit" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="edit-pcsscrapped" class="form-label">Pcs Scrapped</label>
                                <input type="number" name="PcsScrapped" id="edit-pcsscrapped" class="form-control" />
                            </div>
                        </div>

                        <!-- Discrepancy -->
                        <div class="mb-3">
                            <label for="edit-discrepancy" class="form-label">Discrepancy</label>
                            <textarea name="Discrepancy" id="edit-discrepancy" class="form-control"></textarea>
                        </div>

                        <!-- Date -->
                        <div class="mb-3">
                            <label for="edit-date" class="form-label">Date</label>
                            <input type="date" name="Date" id="edit-date" class="form-control" />
                        </div>

                        <!-- Disposition -->
                        <div class="mb-3">
                            <label for="edit-disposition" class="form-label">Disposition</label>
                            <textarea name="Disposition" id="edit-disposition" class="form-control"></textarea>
                        </div>

                        <!-- Disposition By -->
                        <div class="mb-3">
                            <label for="edit-dispositionby" class="form-label">Disposition By</label>
                            <select name="DispositionBy" id="edit-dispositionby" class="form-control">
                                <option value="">-- Select Operator --</option>
                                @if (ViewBag.DispositionOperators != null)
                                {
                                    foreach (var op in (List<string>)ViewBag.DispositionOperators)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Rework Instructions -->
                        <div class="mb-3">
                            <label for="edit-reworkinstr" class="form-label">Rework Instructions</label>
                            <textarea name="ReworkInstr" id="edit-reworkinstr" class="form-control"></textarea>
                        </div>

                        <!-- Rework Instr By -->
                        <div class="mb-3">
                            <label for="edit-reworkinstrby" class="form-label">Rework Instr By</label>
                            <select name="ReworkInstrBy" id="edit-reworkinstrby" class="form-control">
                                <option value="">-- Select Operator --</option>
                                @if (ViewBag.ReworkOperators != null)
                                {
                                    foreach (var op in (List<string>)ViewBag.ReworkOperators)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Date Completed -->
                        <div class="mb-3">
                            <label for="edit-datecompleted" class="form-label">Date Completed</label>
                            <input type="date" name="DateCompleted" id="edit-datecompleted" class="form-control" />
                        </div>

                        <hr />

                        <!-- ✅ Files -->
                        <div class="mb-3">
                            <label class="form-label">File 1</label>
                            <input type="hidden" name="FileAddress1" id="edit-fileaddress1" />
                            <input type="file" name="FileUpload1" id="edit-file1" class="form-control" accept="image/*,.pdf" />
                            <div id="current-file1" class="mt-2 text-break"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">File 2</label>
                            <input type="hidden" name="FileAddress2" id="edit-fileaddress2" />
                            <input type="file" name="FileUpload2" id="edit-file2" class="form-control" accept="image/*,.pdf" />
                            <div id="current-file2" class="mt-2 text-break"></div>
                        </div>
                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- NEW: Hidden Form for Direct File Upload (replaces the modal for Add/Update File1) -->
<form id="hiddenUpdateFileForm" asp-action="UpdateFile" method="post" enctype="multipart/form-data" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="hiddenRecordId" value="" />
    <input type="file" name="file" id="hiddenFileInput" />
</form>

<!-- Somewhere near bottom of HoldTag/Index.cshtml -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContainer" class="w-100"></div>
            </div>
        </div>
    </div>
</div>



@section Scripts {

    <!-- jQuery DataTables JS (uses the jQuery already in your layout) -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Optional: DataTables Bootstrap 5 CSS (for nicer styling on this page only) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
   

    <!-- QR Code Generation for Both QR Codes -->
    <script>


        window.__holdtagPrefilled = false;


        document.addEventListener('DOMContentLoaded', function () {
            // Generate QR code for the current page
            var currentUrl = window.location.href;
            QRCode.toCanvas(document.getElementById('current-page-qr'), currentUrl, {
                width: 128
            }, function (error) {
                if (error) {
                    console.error(error);
                } else {
                    console.log("Current page QR code generated!");
                }
            });

            // Generate QR code for Wi‑Fi connection
            var wifiData = `WIFI:T:WPA;S:Sintergy-WiFi;P:5intergyW1F1;;`;
            QRCode.toCanvas(document.getElementById('wifi-qr'), wifiData, {
                width: 128
            }, function (error) {
                if (error) {
                    console.error(error);
                } else {
                    console.log("Wi‑Fi QR code generated!");
                }
            });
        });
    </script>
   
    <!-- Table Filtering and Sorting Scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            function esc(v) {
                if (v === null || v === undefined) return "";
                return String(v)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }

            function buildDetailHtml($tr) {
                const issuedBy      = $tr.attr("data-issuedby") || "";
                const discrepancy   = $tr.attr("data-discrepancy") || "";
                const disposition   = $tr.attr("data-disposition") || "";
                const dispositionBy = $tr.attr("data-dispositionby") || "";
                const reworkInstr   = $tr.attr("data-reworkinstr") || "";
                const reworkBy      = $tr.attr("data-reworkinstrby") || "";
                const qtyTags       = $tr.attr("data-qtytags") || "";
                const pcsScrapped   = $tr.attr("data-pcsscrapped") || "";
                const dateCompleted = $tr.attr("data-datecompleted") || "";
                const file1         = $tr.attr("data-file1") || "";
                const file2         = $tr.attr("data-file2") || "";

                const fileBtn = (filePath) =>
                    filePath
                        ? `<button type="button" class="btn btn-info btn-sm btn-preview ms-2" data-file="${esc(filePath)}">
                                <i class="bi bi-eye"></i> Preview
                           </button>`
                        : `<span class="muted ms-2">No File</span>`;

                return `
                    <div class="ht-detail">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <span class="label">Issued By:</span> ${esc(issuedBy)}
                            </div>
                            <div class="col-md-4">
                                <span class="label">Hold Tags:</span> ${esc(qtyTags)}
                            </div>
                            <div class="col-md-4">
                                <span class="label">Pcs Scrapped:</span> ${esc(pcsScrapped)}
                            </div>

                            <div class="col-md-12">
                                <span class="label">Discrepancy:</span> ${esc(discrepancy)}
                            </div>

                            <div class="col-md-12">
                                <span class="label">Disposition:</span> ${esc(disposition)}
                                ${dispositionBy ? `<span class="muted ms-2">(By: ${esc(dispositionBy)})</span>` : ``}
                            </div>

                            <div class="col-md-12">
                                <span class="label">Rework Instructions:</span> ${esc(reworkInstr)}
                                ${reworkBy ? `<span class="muted ms-2">(By: ${esc(reworkBy)})</span>` : ``}
                            </div>

                            <div class="col-md-4">
                                <span class="label">Date Completed:</span> ${esc(dateCompleted)}
                            </div>

                            <div class="col-md-4">
                                <span class="label">File 1:</span> ${fileBtn(file1)}
                            </div>

                            <div class="col-md-4">
                                <span class="label">File 2:</span> ${fileBtn(file2)}
                            </div>
                        </div>
                    </div>
                `;
            }

            // ✅ DataTables init with drawCallback to show detail line
                    // ✅ helper: highlight/unhighlight a main row + its child row
        function setOpenHighlight(api, rowNode, isOpen) {
            const $tr = $(rowNode);
            if (!$tr.length) return;

            // main row
            $tr.toggleClass('ht-open', isOpen);

            // child row (detail)
            const dtRow = api.row(rowNode);
            if (dtRow && dtRow.child && dtRow.child.isShown()) {
                $(dtRow.child()).toggleClass('ht-open', isOpen);
            }
        }

        var table = $('#holdTagTable').DataTable({
            pageLength: 25,
            lengthMenu: [10, 25, 50, 100],
            order: [[0, 'desc']],
            dom:
                '<"row mb-2"' +
                    '<"col-sm-6"l>' +
                    '<"col-sm-6"f>' +
                '>' +
                't' +
                '<"row mt-2"' +
                    '<"col-sm-6"i>' +
                    '<"col-sm-6"p>' +
                '>',


            // ✅ highlight any row where DateCompleted is blank/null
            rowCallback: function (row, data, index) {
                const api = this.api();

                // you set this in Razor: data-datecompleted="yyyy-MM-dd" or ""
                const dateCompleted = ($(row).attr('data-datecompleted') || '').trim();

                const isOpen = !dateCompleted; // blank => open (not completed)
                setOpenHighlight(api, row, isOpen);
            },

            // ✅ always build/show the detail child row + apply highlight to it too
            drawCallback: function () {
                const api = this.api();

                api.rows({ page: 'current' }).every(function () {
                    const row = this;
                    const node = row.node();
                    if (!node) return;

                    const $tr = $(node);

                    const html = buildDetailHtml($tr);

                    if (!row.child.isShown()) {
                        row.child(html, 'ht-detail-row').show();
                    } else {
                        row.child(html);
                    }

                    // after child is shown/updated, make sure highlight is applied to child too
                    const dateCompleted = ($tr.attr('data-datecompleted') || '').trim();
                    const isOpen = !dateCompleted;
                    setOpenHighlight(api, node, isOpen);
                });
            }
        });


            // --- your existing filters wiring stays, BUT update the Date column index ---
            const searchInput = document.getElementById("recordSearchInput");
            const startDateInput = document.getElementById("recordStartDate");
            const endDateInput = document.getElementById("recordEndDate");
            const clearBtn = document.getElementById("clearFilters");

            if (searchInput) {
                searchInput.addEventListener("keyup", function () {
                    table.search(this.value).draw();
                });
            }

            // ✅ Date column is now the 12th column (0-based index 11)
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                if (settings.nTable.id !== 'holdTagTable') return true;

                var startVal = startDateInput.value;
                var endVal = endDateInput.value;

                var dateStr = data[11] || '';  // yyyy-MM-dd (NEW index)

                if (!startVal && !endVal) return true;
                if (!dateStr) return false;

                var rowDate = new Date(dateStr);
                if (isNaN(rowDate)) return false;

                if (startVal) {
                    var startDate = new Date(startVal);
                    if (rowDate < startDate) return false;
                }

                if (endVal) {
                    var endDate = new Date(endVal);
                    endDate.setDate(endDate.getDate() + 1); // inclusive
                    if (rowDate >= endDate) return false;
                }

                return true;
            });

            function redrawWithDateFilter() { table.draw(); }
            if (startDateInput) startDateInput.addEventListener("change", redrawWithDateFilter);
            if (endDateInput) endDateInput.addEventListener("change", redrawWithDateFilter);

            if (clearBtn) {
                clearBtn.addEventListener("click", function () {
                    if (searchInput) searchInput.value = "";
                    if (startDateInput) startDateInput.value = "";
                    if (endDateInput) endDateInput.value = "";
                    table.search('').draw();
                });
            }
        });
    </script>


    <!-- NEW: Direct file upload script for "Add / Update File1" -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addFileButtons = document.querySelectorAll(".add-file-btn");
            const hiddenFileInput = document.getElementById("hiddenFileInput");
            const hiddenRecordId = document.getElementById("hiddenRecordId");
            const hiddenUpdateFileForm = document.getElementById("hiddenUpdateFileForm");

            addFileButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const recordId = button.getAttribute("data-id");
                    hiddenRecordId.value = recordId; // Set the record id in the hidden form
                    hiddenFileInput.click(); // Directly open the file browser
                });
            });

            hiddenFileInput.addEventListener("change", function () {
                if (hiddenFileInput.files.length > 0) {
                    hiddenUpdateFileForm.submit(); // Auto-submit the form once a file is selected
                }
            });
        });
    </script>



    <script>
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-preview');
            if (!btn) return;

            const fileName = btn.getAttribute('data-file');
            if (!fileName) return;

            try {
                // Hit the HoldTag FetchImage action (returns { success, url })
                const resp = await fetch('/HoldTag/FetchImage?filePath=' + encodeURIComponent(fileName));
                if (!resp.ok) { alert('Failed to fetch file.'); return; }
                const data = await resp.json();
                if (!data.success || !data.url) { alert(data.message || 'Could not retrieve file.'); return; }

                const url = data.url;
                const container = document.getElementById('previewContainer');
                if (!container) return;

                container.innerHTML = '';
                const lower = (fileName || '').toLowerCase();

                const isPdf = lower.endsWith('.pdf');
                const isVideo = lower.endsWith('.mp4') || lower.endsWith('.webm') ||
                                lower.endsWith('.ogg') || lower.endsWith('.mov') ||
                                lower.endsWith('.m4v');

                if (isPdf) {
                    const el = document.createElement('embed');
                    el.src = url;
                    el.type = 'application/pdf';
                    el.style.width = '100%';
                    el.style.height = '600px';
                    container.appendChild(el);
                } else if (isVideo) {
                    const el = document.createElement('video');
                    el.src = url;
                    el.controls = true;
                    el.style.width = '100%';
                    el.style.maxHeight = '80vh';
                    container.appendChild(el);
                } else {
                    const el = document.createElement('img');
                    el.src = url;
                    el.alt = 'Preview';
                    el.style.maxWidth = '100%';
                    el.style.maxHeight = '80vh';
                    container.appendChild(el);
                }

                new bootstrap.Modal(document.getElementById('previewModal')).show();
            } catch (err) {
                console.error('Error fetching file:', err);
                alert('Error fetching file.');
            }
        });
    </script>




    <script>
        // Admin edit modal wiring (works with DataTables because of event delegation)
        document.addEventListener("DOMContentLoaded", function () {

                   function stageFromSource(src) {
            src = (src || "").toLowerCase();
            if (src === "pressrun") return "green";
            if (src === "sinterrun") return "sintered";
            return null;
        }

                         function sourceFromStage(stage) {
            stage = (stage || "").toLowerCase();
            if (stage === "green") return "pressrun";
            if (stage === "sintered") return "sinterrun";
            return "manual";
        }

        // ✅ Keep hidden source in sync when admin changes the Stage dropdown
        const stageSelectGlobal = document.getElementById("edit-stage");
        const sourceHiddenGlobal = document.getElementById("edit-source");
        if (stageSelectGlobal && sourceHiddenGlobal) {
            stageSelectGlobal.addEventListener("change", function () {
               sourceHiddenGlobal.value = sourceFromStage(stageSelectGlobal.value);

            });
        }


            const tbody = document.querySelector("#holdTagTable tbody");
            if (!tbody) return;

            tbody.addEventListener("click", function (e) {
                const btn = e.target.closest(".edit-btn");
                if (!btn) return;

                // ✅ Read source from the button (you already have data-source on it)
                const source = btn.dataset.source || "";

        const stage  = btn.dataset.stage  || "";
                const id = btn.dataset.id;
                const part = btn.dataset.part;
                const component = btn.dataset.component;
                const discrepancy = btn.dataset.discrepancy;
                const date = btn.dataset.date;
                const issuedBy = btn.dataset.issuedby;
                const disposition = btn.dataset.disposition;
                const dispositionBy = btn.dataset.dispositionby;
                const reworkInstr = btn.dataset.reworkinstr;
                const reworkInstrBy = btn.dataset.reworkinstrby;
                const quantity = btn.dataset.quantity;
                const unit = btn.dataset.unit;
                const pcsScrapped = btn.dataset.pcsscrapped;
                const dateCompleted = btn.dataset.datecompleted;
                const fileAddress1 = btn.dataset.fileaddress1;
                const fileAddress2 = btn.dataset.fileaddress2;
                const prodNumber = btn.dataset.prodnumber;
                const quantityOnHold = btn.dataset.quantityonhold;
                const lotNumber = btn.dataset.lotnumber;
                const materialCode = btn.dataset.materialcode;
                const runNumber = btn.dataset.runnumber;
                const skidNumber = btn.dataset.skidnumber;

                document.getElementById("edit-id").value = id || "";
                document.getElementById("edit-part").value = part || "";
                document.getElementById("edit-component").value = component || "";
                document.getElementById("edit-discrepancy").value = discrepancy || "";
                document.getElementById("edit-date").value = date || "";
                document.getElementById("edit-issuedby").value = issuedBy || "";
                document.getElementById("edit-disposition").value = disposition || "";
                document.getElementById("edit-dispositionby").value = dispositionBy || "";
                document.getElementById("edit-reworkinstr").value = reworkInstr || "";
                document.getElementById("edit-reworkinstrby").value = reworkInstrBy || "";
                document.getElementById("edit-quantity").value = quantity || "";
                document.getElementById("edit-quantityonhold").value = quantityOnHold || "";
                document.getElementById("edit-lotnumber").value = lotNumber || "";
                document.getElementById("edit-materialcode").value = materialCode || "";
                document.getElementById("edit-prodnumber").value = prodNumber || "";
                document.getElementById("edit-runnumber").value = runNumber || "";
                document.getElementById("edit-unit").value = unit || "";
                document.getElementById("edit-pcsscrapped").value = pcsScrapped || "";
                document.getElementById("edit-datecompleted").value = dateCompleted || "";
                document.getElementById("edit-skidnumber").value = (skidNumber ?? 0);

                // ✅ Stage + hidden Source mapping (THIS IS #7)
                const stageSelect = document.getElementById("edit-stage");
                const sourceHidden = document.getElementById("edit-source");

                               if (stageSelect) {
            // Prefer the record's Stage (Heat Treated, Machined, etc.)
            if (stage && stage.trim()) {
                stageSelect.value = stage.toLowerCase();
            } else {
                // Fallback for older records that only had Source
                const mappedStage = stageFromSource(source);
                if (mappedStage) stageSelect.value = mappedStage;
            }
        }

        if (sourceHidden) {
            sourceHidden.value = sourceFromStage(stageSelect ? stageSelect.value : "");
        }


                // Files UI
                document.getElementById("edit-fileaddress1").value = fileAddress1 || "";
                document.getElementById("current-file1").innerHTML = fileAddress1
                    ? `<a href="/HoldTag/StreamFile?name=${encodeURIComponent(fileAddress1)}" target="_blank">Current File 1</a>`
                    : "No file uploaded for File 1";

                document.getElementById("edit-fileaddress2").value = fileAddress2 || "";
                document.getElementById("current-file2").innerHTML = fileAddress2
                    ? `<a href="/HoldTag/StreamFile?name=${encodeURIComponent(fileAddress2)}" target="_blank">Current File 2</a>`
                    : "No file uploaded for File 2";

                const modalEl = document.getElementById("editModal");
                new bootstrap.Modal(modalEl).show();
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const partInput   = document.getElementById('ModalPart');
            const compInput   = document.getElementById('ModalComponent');
            const prodInput   = document.getElementById('ModalProdNumber');
            const runInput    = document.getElementById('ModalRunNumber');
            const lotInput    = document.getElementById('ModalLotNumber');
            const matInput    = document.getElementById('ModalMaterialCode');

            let scanBusy = false;

                   async function doScanLookup(mode, code) {
            if (!code || scanBusy) return;
            scanBusy = true;

            try {
                const url = `/HoldTag/ScanLookup?mode=${encodeURIComponent(mode)}&code=${encodeURIComponent(code)}`;
                const resp = await fetch(url);

                if (!resp.ok) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Lookup Error',
                        text: 'Failed to contact server for scan lookup.'
                    });
                    return;
                }

                const data = await resp.json();

                if (!data.success) {
                    // Clear the auto-fill fields if we didn’t find anything
                    partInput.value = "";
                    if (compInput) compInput.value = "";
                    lotInput.value  = "";
                    matInput.value  = "";

                    await Swal.fire({
                        icon: 'warning',
                        title: 'Not Found',
                        text: data.message || `No records found for ${mode === 'prod' ? 'Production' : 'Run'} number "${code}".`
                    });

                    return;
                }

                // ✅ Fill from result
                partInput.value = data.part || "";
                if (compInput) compInput.value = data.component || "";
                lotInput.value  = data.lotNumber || "";
                matInput.value  = data.materialCode || "";

                if (mode === 'prod') {
                    prodInput.value = data.prodNumber || code;
                    if (runInput && data.runNumber) runInput.value = data.runNumber;
                } else if (mode === 'run') {
                    runInput.value = data.runNumber || code;
                    if (prodInput && data.prodNumber) prodInput.value = data.prodNumber;
                }

                console.log("Scan source:", data.source);
                        // If scan lookup returns a source, set stage + inferred hidden source
        const stageSelect = document.getElementById('ModalStage');
        const sourceHidden = document.getElementById('ModalSource');

                      function stageFromSource(src) {
            src = (src || "").toLowerCase();
            if (src === "pressrun") return "green";
            if (src === "sinterrun") return "sintered";
            return null; // ✅ don't change stage if unknown
        }
        function sourceFromStage(stage) {
            stage = (stage || "").toLowerCase();
            if (stage === "green") return "pressrun";
            if (stage === "sintered") return "sinterrun";
            return "manual"; // ✅ future stages save as manual
        }


               // If ScanLookup returns a known source, set Stage from it
        if (data.source && stageSelect) {
            const mappedStage = stageFromSource(data.source);
            if (mappedStage) stageSelect.value = mappedStage;
        }

        // Always compute Source from the current Stage (green/sintered -> press/sinter, else manual)
        if (sourceHidden && stageSelect) {
            sourceHidden.value = sourceFromStage(stageSelect.value);
        }


                // ✅ SUCCESS TOAST
                await Swal.fire({
                    icon: 'success',
                    title: 'Info Loaded',
                    html: `
                        <div style="text-align:left;">
                            <strong>Part:</strong> ${data.part || 'N/A'}<br/>
                            <strong>Component:</strong> ${data.component || 'N/A'}<br/>
                            <strong>Lot #:</strong> ${data.lotNumber || 'N/A'}<br/>
                            <strong>Material:</strong> ${data.materialCode || 'N/A'}
                        </div>
                    `,
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (err) {
                console.error('ScanLookup error:', err);
                await Swal.fire({
                    icon: 'error',
                    title: 'Lookup Error',
                    text: 'An unexpected error occurred during scan lookup.'
                });
            } finally {
                scanBusy = false;
            }
        }


                   function wireField(input, mode) {
            if (!input) return;

            // remember the last code we successfully looked up for this field
            let lastCode = "";

            function triggerLookup() {
                const code = input.value.trim();
                if (!code) return;

                // don't re-lookup the same value over and over
                if (code === lastCode) return;

                lastCode = code;
                doScanLookup(mode, code);
            }

            // 1) Scanner / power-user: Enter still works
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    triggerLookup();
                }
            });

            // 2) Normal typing: when they TAB or click out (value changed), do lookup
            input.addEventListener('change', function () {
                triggerLookup();
            });

            // Optional: also on blur (in case browser doesn't fire change reliably)
            input.addEventListener('blur', function () {
                triggerLookup();
            });
        }


            wireField(prodInput, 'prod');
            wireField(runInput,  'run');
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            @if (TempData["SuccessMessage"] != null)
            {
                    <text>
                    Swal.fire({
                        icon: 'success',
                        title: 'Hold Tag Submitted',
                        text: '@TempData["SuccessMessage"]',
                        confirmButtonText: 'OK'
                    });
                    </text>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                    <text>
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: '@TempData["ErrorMessage"]',
                        confirmButtonText: 'OK'
                    });
                    </text>
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {

            // prevent duplicate auto-runs
                   // only run once per page load
        window.__holdtagPrefilled = window.__holdtagPrefilled || false;
        if (window.__holdtagPrefilled) return;

        const qs = new URLSearchParams(window.location.search);
        const source = (qs.get('source') || '').trim();
        const run = (qs.get('run') || '').trim();
        const prodNumber = (qs.get('prodNumber') || '').trim();
        const skidNumber = (qs.get('skidNumber') || qs.get('skid') || '').trim();

        if (!source) return;
        if (!run && !prodNumber) return;

        // ✅ set flag early so other DOMContentLoaded handlers don't cause double-fires
        window.__holdtagPrefilled = true;


            try {
                      const url =
        `/HoldTag/SourcePrefill?source=${encodeURIComponent(source)}`
        + `&run=${encodeURIComponent(run)}`
        + `&prodNumber=${encodeURIComponent(prodNumber)}`
        + `&skidNumber=${encodeURIComponent(skidNumber)}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Prefill request failed');

                const data = await resp.json();
                if (!data.success) {
                    await Swal.fire({ icon: 'warning', title: 'Prefill', text: data.message || 'No data found.' });
                    return;
                }

                // Fill fields
                       // Stage select from source
        const stageSelect = document.getElementById('ModalStage');
        const sourceHidden = document.getElementById('ModalSource');

        function stageFromSource(src) {
            src = (src || "").toLowerCase();
            if (src === "pressrun") return "green";
            if (src === "sinterrun") return "sintered";
            return "";
        }

                function sourceFromStage(stage) {
            stage = (stage || "").toLowerCase();
            if (stage === "green") return "pressrun";
            if (stage === "sintered") return "sinterrun";
            return null; // ✅ do NOT blank for other stages
        }

               const resolvedSource = (data.source || source || "").trim();

        // set Stage only if known from resolvedSource
        if (stageSelect) {
            const mappedStage = stageFromSource(resolvedSource);
            if (mappedStage) stageSelect.value = mappedStage;
        }

        // always compute Source from the current Stage (else manual)
        if (sourceHidden) {
            sourceHidden.value = sourceFromStage(stageSelect ? stageSelect.value : "");
        }



                document.getElementById('ModalRunNumber').value  = data.runNumber  || run || '';
                document.getElementById('ModalProdNumber').value = data.prodNumber || prodNumber || '';

                document.getElementById('ModalSkidNumber').value = skidNumber || '';
                document.getElementById('ModalPart').value         = data.part || '';
                document.getElementById('ModalComponent').value    = data.component || '';
                document.getElementById('ModalMaterialCode').value = data.materialCode || '';
                document.getElementById('ModalLotNumber').value    = data.lotNumber || '';

                // ✅ Qty on hold + unit (prefer quantityOnHold; fallback to pcs)
                const qty = (data.quantityOnHold ?? data.pcs);
                if (qty !== null && qty !== undefined && qty !== '') {
                    document.getElementById('ModalQuantityOnHold').value = qty;
                } else {
                    document.getElementById('ModalQuantityOnHold').value = '';
                }

                // ✅ Map unit to your dropdown values
                const unitRaw = (data.unit || '').toLowerCase().trim();
                const unitMap = {
                    "pcs": "pc",
                    "pc": "pc",
                    "piece": "pc",
                    "pieces": "pc",
                    "skids": "skid",
                    "skid": "skid",
                    "trays": "tray",
                    "tray": "tray",
                    "totes": "tote",
                    "tote": "tote",
                    "barrels": "barrel",
                    "barrel": "barrel"
                };

                const unitVal = unitMap[unitRaw] || (unitRaw.endsWith("s") ? unitMap[unitRaw.slice(0, -1)] : null) || unitRaw;

                const unitSelect = document.getElementById('ModalUnit');
                if (unitSelect && unitVal) {
                    // only set if option exists
                    const opt = unitSelect.querySelector(`option[value="${unitVal}"]`);
                    if (opt) unitSelect.value = unitVal;
                }

                // Open modal
                const modalEl = document.getElementById('addRequestModal');
                new bootstrap.Modal(modalEl).show();

                await Swal.fire({
                    icon: 'success',
                    title: 'Loaded: ' + (stageSelect ? (stageSelect.options[stageSelect.selectedIndex]?.text || 'Stage') : 'Stage'),

                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (err) {
                console.error(err);
                await Swal.fire({ icon: 'error', title: 'Prefill Error', text: 'Failed to auto-load hold tag info.' });

                // allow retry on refresh if something broke
                window.__holdtagPrefilled = false;
            }
        });
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modalEl = document.getElementById('addRequestModal');
            if (!modalEl) return;

            modalEl.addEventListener('hidden.bs.modal', function () {
                window.__holdtagPrefilled = false;
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stageSelect = document.getElementById('ModalStage');
            const sourceHidden = document.getElementById('ModalSource');
            if (!stageSelect || !sourceHidden) return;

                          function inferSourceFromStage(stage) {
            stage = (stage || "").toLowerCase();
            if (stage === "green") return "pressrun";
            if (stage === "sintered") return "sinterrun";
            return "manual"; // ✅ future stages save as manual
        }

        function applyInference() {
            sourceHidden.value = inferSourceFromStage(stageSelect.value);
        }



            stageSelect.addEventListener('change', applyInference);

            // ensure correct on initial load/prefill
            applyInference();
        });
    </script>

}
