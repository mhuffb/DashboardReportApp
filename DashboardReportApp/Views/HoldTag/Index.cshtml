@model DashboardReportApp.Models.HoldTagIndexViewModel
@using System.Text.Json
@{
    var isAdmin = (ViewBag.IsAdmin as bool?) ?? false;
}

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
    #imageModal .modal-dialog {
        max-width: 95% !important;
    }

    #imageModal .modal-body {
        padding: 0;
        background-color: #000;
    }
</style>


<h1 class="text-center mb-4">Hold Tag</h1>

<!-- NEW: Add Request Button -->
<div class="text-center mb-4">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRequestModal">
        Add Request
    </button>
</div>

<div class="container-fluid px-3 mt-4">
    <!-- Instructional Message -->
    <div class="row justify-content-center">
        <h8 class="text-center mb-4">You can upload pictures from your phone by connecting to wifi then viewing this page on your phone.</h8>
    </div>

    <!-- QR Codes and Immediate Assistance Card in one row -->
    <div class="d-flex justify-content-evenly align-items-center mb-4 flex-wrap">
        <!-- Wi‑Fi QR Code -->
        <div class="text-center mb-3">
            <canvas id="wifi-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">Connect to Wifi</div>
        </div>

        <!-- Immediate Assistance Card -->
        <div class="card shadow mb-3" style="max-width: 300px;">
            <div class="card-body p-2">
                <p class="text-center mb-2" style="font-size: 0.9rem;">
                    For immediate assistance, call/text until you get an answer:
                </p>
                <ul class="list-group" style="font-size: 0.8rem;">
                    <li class="list-group-item p-1">Tom Grieneisen 814-591-2704</li>
                    <li class="list-group-item p-1">Chico Almendarez 814-541-1181</li>
                    <li class="list-group-item p-1">Anthony Meholick 814-591-4074</li>
                    <li class="list-group-item p-1">Roger Jones 814-939-9412</li>
                </ul>
            </div>
        </div>

        <!-- Current Page QR Code -->
        <div class="text-center mb-3">
            <canvas id="current-page-qr" style="width:128px; height:128px;"></canvas>
            <div class="mt-2">View on your device</div>
        </div>
    </div>
</div>

<!-- READ-ONLY TABLE OF HOLD TAG RECORDS -->
<div class="container-fluid px-3 mt-4">
    <h2 class="text-center mb-4">Hold Tag Records</h2>
    <!-- Filters for the table -->
    <div class="row mb-3 justify-content-center">
        <div class="col-auto">
            <input type="text" id="recordSearchInput" class="form-control" placeholder="Search records..." style="max-width: 200px;" />
        </div>
        <div class="col-auto d-flex">
            <input type="date" id="recordStartDate" class="form-control me-2" style="max-width: 150px;" />
            <input type="date" id="recordEndDate" class="form-control" style="max-width: 150px;" />
        </div>
        <div class="col-auto">
            <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
        </div>
    </div>

    <div class="table-responsive">
        <table id="holdTagTable" class="table table-striped table-bordered shadow-sm custom-table" style="width:100%; border-collapse:collapse;">
            <thead class="table-dark">
                <tr>
                    <th class="sortable" data-label="ID" style="width: 3%;">ID</th>
                    <th class="sortable" data-label="Part" style="width: 7%;">Part</th>
                    <th class="sortable" data-label="ProdNumber" style="width: 7%;">Production #</th>
                    <th class="sortable" data-label="Discrepancy" style="width: 10%;">Discrepancy</th>
                    <th class="sortable" data-label="Date" style="width: 7%;">Date</th>
                    <th class="sortable" data-label="Issued By" style="width: 7%;">Issued By</th>
                    <th class="sortable" data-label="Disposition" style="width: 10%;">Disposition</th>
                    <th class="sortable" data-label="Disposition By" style="width: 6%;">Disposition By</th>
                    <th class="sortable" data-label="Rework Instructions" style="width: 10%;">Rework Instructions</th>
                    <th class="sortable" data-label="Rework Instr By" style="width: 7%;">Rework Instr By</th>
                    <th class="sortable" data-label="Quantity" style="width: 4%;">Quantity</th>
                    <th class="sortable" data-label="Unit" style="width: 7%;">Unit</th>
                    <th class="sortable" data-label="Pcs Scrapped" style="width: 4%;">Pcs Scrapped</th>
                    <th class="sortable" data-label="Date Completed" style="width: 7%;">Date Completed</th>
                    <th class="sortable" data-label="File1" style="width: 5%;">File 1</th>
                    <th class="sortable" data-label="File2" style="width: 5%;">File 2</th>
                    <th style="width: 6%;">Actions</th> <!-- keep Add/Update + possibly Edit -->
                </tr>
            </thead>

            <tbody>
                @foreach (var record in Model.Records)
                {
                    <tr>
                        <td>@record.Id</td>
                        <td>@record.Part</td>
                        <td>@record.ProdNumber</td>
                        <td>@record.Discrepancy</td>
                        <td>@(record.Date?.ToString("yyyy-MM-dd") ?? "")</td>
                        <td>@record.IssuedBy</td>
                        <td>@record.Disposition</td>
                        <td>@record.DispositionBy</td>
                        <td>@record.ReworkInstr</td>
                        <td>@record.ReworkInstrBy</td>
                        <td>@record.Quantity</td>
                        <td>@record.Unit</td>
                        <td>@record.PcsScrapped</td>
                        <td>@(record.DateCompleted?.ToString("yyyy-MM-dd") ?? "")</td>
                        <td>
                            @if (!string.IsNullOrEmpty(record.FileAddress1))
                            {
                                <button type="button"
                                        class="btn btn-info btn-sm btn-preview"
                                        data-file="@record.FileAddress1">
                                    <i class="bi bi-eye"></i> Preview
                                </button>
                            }
                            else
                            {

                                <span>No File</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(record.FileAddress2))
                            {
                                <button type="button"
                                        class="btn btn-info btn-sm btn-preview"
                                        data-file="@record.FileAddress2">
                                    <i class="bi bi-eye"></i> Preview
                                </button>
                            }
                            else
                            {

                                <span>No File</span>
                            }
                        </td>


                        <td>
                            @* Show Add / Update File1 ONLY for non-admins *@
                            @if (!isAdmin)
                            {
                                <button type="button"
                                        class="btn btn-secondary btn-sm add-file-btn"
                                        data-id="@record.Id">
                                    Add / Update File1
                                </button>
                            }

                            @* Show Edit ONLY for admins *@
                            @if (isAdmin)
                            {
                                <button type="button"
                                        class="btn btn-primary btn-sm edit-btn mt-1"
                                        data-id="@record.Id"
                                        data-part="@record.Part"
                                        data-discrepancy="@record.Discrepancy"
                                        data-date="@(record.Date?.ToString("yyyy-MM-dd") ?? "")"
                                        data-issuedby="@record.IssuedBy"
                                        data-disposition="@record.Disposition"
                                        data-dispositionby="@record.DispositionBy"
                                        data-reworkinstr="@record.ReworkInstr"
                                        data-reworkinstrby="@record.ReworkInstrBy"
                                        data-quantity="@record.Quantity"
                                        data-unit="@record.Unit"
                                        data-pcsscrapped="@(record.PcsScrapped?.ToString() ?? "")"
                                        data-datecompleted="@(record.DateCompleted?.ToString("yyyy-MM-dd") ?? "")"
                                        data-fileaddress1="@record.FileAddress1"
                                        data-fileaddress2="@record.FileAddress2"
                                        data-prodnumber="@record.ProdNumber">
                                    Edit
                                </button>
                            }
                        </td>

                    </tr>
                }
            </tbody>

        </table>
    </div>
</div>

<!-- Modal for "Add Request" -->
<!-- NEW: Modal for "Add Request" -->
<div class="modal fade" id="addRequestModal" tabindex="-1" aria-labelledby="addRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRequestModalLabel">Add Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Submit" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <!-- PART -->
                    <div class="mb-3">
                        <label for="ModalPart" class="form-label">Part</label>
                        <input type="text"
                               id="ModalPart"
                               name="Part"
                               class="form-control"
                               required />
                        <span asp-validation-for="FormModel.Part" class="text-danger"></span>
                    </div>
                    <!-- PRODUCTION NUMBER -->
                    <div class="mb-3">
                        <label for="ModalProdNumber" class="form-label">Production Number</label>
                        <input type="text"
                               id="ModalProdNumber"
                               name="ProdNumber"
                               class="form-control"
                               list="ProdNumberList"
                               autocomplete="off"
                               required />

                        <datalist id="ProdNumberList"></datalist>
                        <span asp-validation-for="FormModel.ProdNumber" class="text-danger"></span>
                    </div>

                    <!-- OPERATOR -->
                    <div class="mb-3">
                        <label for="ModalIssuedBy" class="form-label">Issued By (Operator)</label>
                        <select id="ModalIssuedBy" name="IssuedBy" class="form-control">
                            <option value="">-- Select Operator --</option>
                            @if (ViewData["Operators"] is List<string> opList1)
                            {
                                foreach (var op in opList1)
                                {
                                    <option value="@op">@op</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="FormModel.IssuedBy" class="text-danger"></span>
                    </div>
                    <!-- DISCREPANCY -->
                    <div class="mb-3">
                        <label for="ModalDiscrepancy" class="form-label">Discrepancy</label>
                        <textarea id="ModalDiscrepancy" name="Discrepancy" class="form-control text-area-large" required></textarea>
                        <span asp-validation-for="FormModel.Discrepancy" class="text-danger"></span>
                    </div>
                    <!-- QUANTITY -->
                    <div class="mb-3">
                        <label for="ModalQuantity" class="form-label">Quantity of Holdtags</label>
                        <input type="number" id="ModalQuantity" name="Quantity" class="form-control" required />
                        <span asp-validation-for="FormModel.Quantity" class="text-danger"></span>
                    </div>
                    <!-- UNIT -->
                    <div class="mb-3">
                        <label for="ModalUnit" class="form-label">Unit</label>
                        <select id="ModalUnit" name="Unit" class="form-control">
                            <option value="skid" data-singular="skid" data-plural="skids">Skid</option>
                            <option value="tray" data-singular="tray" data-plural="trays">Tray</option>
                            <option value="tote" data-singular="tote" data-plural="totes">Tote</option>
                            <option value="barrel" data-singular="barrel" data-plural="barrels">Barrel</option>
                            <option value="pc" data-singular="pc" data-plural="pcs">Pc</option>
                        </select>
                        <span asp-validation-for="FormModel.Unit" class="text-danger"></span>
                    </div>
                    <!-- File Upload -->
                    <div class="mb-3">
                        <label for="ModalFile" class="form-label">Attach File (Optional)</label>
                        <input type="file" name="file" id="ModalFile" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
@if (isAdmin)
{
    <!-- Admin: Edit Record Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="HoldTag" asp-action="UpdateRequest" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <input type="hidden" name="Id" id="edit-id" />
                        <div class="mb-3">
                            <label for="edit-prodnumber" class="form-label">Production Number</label>
                            <input type="text" name="ProdNumber" id="edit-prodnumber" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="edit-part" class="form-label">Part</label>
                            <input type="text" name="Part" id="edit-part" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="edit-discrepancy" class="form-label">Discrepancy</label>
                            <textarea name="Discrepancy" id="edit-discrepancy" class="form-control"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="edit-date" class="form-label">Date</label>
                            <input type="date" name="Date" id="edit-date" class="form-control" />
                        </div>

                        <!-- Issued By Dropdown -->
                        <div class="mb-3">
                            <label for="edit-issuedby" class="form-label">Issued By</label>
                            <select name="IssuedBy" id="edit-issuedby" class="form-control">
                                <option value="">-- Select Operator --</option>
                                @if (ViewBag.IssuedByOperators != null)
                                {
                                    foreach (var op in (List<string>)ViewBag.IssuedByOperators)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-disposition" class="form-label">Disposition</label>
                            <textarea name="Disposition" id="edit-disposition" class="form-control"></textarea>
                        </div>

                        <!-- Disposition By Dropdown -->
                        <div class="mb-3">
                            <label for="edit-dispositionby" class="form-label">Disposition By</label>
                            <select name="DispositionBy" id="edit-dispositionby" class="form-control">
                                <option value="">-- Select Operator --</option>
                                @if (ViewBag.DispositionOperators != null)
                                {
                                    foreach (var op in (List<string>)ViewBag.DispositionOperators)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-reworkinstr" class="form-label">Rework Instructions</label>
                            <textarea name="ReworkInstr" id="edit-reworkinstr" class="form-control"></textarea>
                        </div>

                        <!-- Rework Instr By Dropdown -->
                        <div class="mb-3">
                            <label for="edit-reworkinstrby" class="form-label">Rework Instr By</label>
                            <select name="ReworkInstrBy" id="edit-reworkinstrby" class="form-control">
                                <option value="">-- Select Operator --</option>
                                @if (ViewBag.ReworkOperators != null)
                                {
                                    foreach (var op in (List<string>)ViewBag.ReworkOperators)
                                    {
                                        <option value="@op">@op</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-quantity" class="form-label">Quantity</label>
                            <input type="number" name="Quantity" id="edit-quantity" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="edit-unit" class="form-label">Unit</label>
                            <input type="text" name="Unit" id="edit-unit" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="edit-pcsscrapped" class="form-label">Pcs Scrapped</label>
                            <input type="number" name="PcsScrapped" id="edit-pcsscrapped" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label for="edit-datecompleted" class="form-label">Date Completed</label>
                            <input type="date" name="DateCompleted" id="edit-datecompleted" class="form-control" />
                        </div>

                        <!-- File 1 -->
                        <div class="mb-3">
                            <label class="form-label">File 1</label>
                            <input type="hidden" name="FileAddress1" id="edit-fileaddress1" />
                            <input type="file" name="FileUpload1" id="edit-file1" class="form-control" accept="image/*,.pdf" />
                            <div id="current-file1" class="mt-2 text-break"></div>
                        </div>

                        <!-- File 2 -->
                        <div class="mb-3">
                            <label class="form-label">File 2</label>
                            <input type="hidden" name="FileAddress2" id="edit-fileaddress2" />
                            <input type="file" name="FileUpload2" id="edit-file2" class="form-control" accept="image/*,.pdf" />
                            <div id="current-file2" class="mt-2 text-break"></div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- NEW: Hidden Form for Direct File Upload (replaces the modal for Add/Update File1) -->
<form id="hiddenUpdateFileForm" asp-action="UpdateFile" method="post" enctype="multipart/form-data" style="display:none;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" id="hiddenRecordId" value="" />
    <input type="file" name="file" id="hiddenFileInput" />
</form>

<!-- Somewhere near bottom of HoldTag/Index.cshtml -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContainer" class="w-100"></div>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <!-- jQuery DataTables JS (uses the jQuery already in your layout) -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Optional: DataTables Bootstrap 5 CSS (for nicer styling on this page only) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
   

    <!-- QR Code Generation for Both QR Codes -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Generate QR code for the current page
            var currentUrl = window.location.href;
            QRCode.toCanvas(document.getElementById('current-page-qr'), currentUrl, {
                width: 128
            }, function (error) {
                if (error) {
                    console.error(error);
                } else {
                    console.log("Current page QR code generated!");
                }
            });

            // Generate QR code for Wi‑Fi connection
            var wifiData = `WIFI:T:WPA;S:Sintergy-WiFi;P:5intergyW1F1;;`;
            QRCode.toCanvas(document.getElementById('wifi-qr'), wifiData, {
                width: 128
            }, function (error) {
                if (error) {
                    console.error(error);
                } else {
                    console.log("Wi‑Fi QR code generated!");
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const partInput = document.getElementById('ModalPart');
            const prodInput = document.getElementById('ModalProdNumber');
            const prodList = document.getElementById('ProdNumberList');

            async function loadProdNumbersForPart() {
                const part = partInput.value.trim();
                prodList.innerHTML = '';

                if (!part) {
                    return;
                }

                try {
                    const resp = await fetch(`/HoldTag/ProdNumbersForPart?part=${encodeURIComponent(part)}`);
                    if (!resp.ok) {
                        throw new Error('Failed to load production numbers.');
                    }

                    const data = await resp.json(); // expected: ["12345","23456",...]
                    data.forEach(pn => {
                        const opt = document.createElement('option');
                        opt.value = pn;
                        prodList.appendChild(opt);
                    });
                } catch (err) {
                    console.error('Error fetching prod numbers:', err);
                }
            }

            // Load suggestions when they leave the Part box or change it
            if (partInput) {
                partInput.addEventListener('blur', loadProdNumbersForPart);
                partInput.addEventListener('change', loadProdNumbersForPart);
            }
        });
    </script>

    <!-- Table Filtering and Sorting Scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize DataTable
            var table = $('#holdTagTable').DataTable({
                // default page length and options
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                // order by ID desc by default (column 0)
                order: [[0, 'desc']],
                // Bootstrap-friendly layout
                dom:
                    '<"row mb-2"' +
                        '<"col-sm-6"l>' +
                        '<"col-sm-6"f>' +
                    '>' +
                    't' +
                    '<"row mt-2"' +
                        '<"col-sm-6"i>' +
                        '<"col-sm-6"p>' +
                    '>',
            });

            const searchInput = document.getElementById("recordSearchInput");
            const startDateInput = document.getElementById("recordStartDate");
            const endDateInput = document.getElementById("recordEndDate");
            const clearBtn = document.getElementById("clearFilters");

            // Hook your custom search box to DataTables search
            if (searchInput) {
                searchInput.addEventListener("keyup", function () {
                    table.search(this.value).draw();
                });
            }

            // Custom date range filter using DataTables' ext.search
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                // Only apply to this table
                if (settings.nTable.id !== 'holdTagTable') {
                    return true;
                }

                var startVal = startDateInput.value;
                var endVal = endDateInput.value;

                // Date column index (0-based) -> "Date" is column 3
                var dateStr = data[4] || '';  // yyyy-MM-dd from your Razor output

                if (!startVal && !endVal) {
                    return true; // no date filters
                }

                if (!dateStr) {
                    return false; // row has no date; hide when filtering by date
                }

                var rowDate = new Date(dateStr);
                if (isNaN(rowDate)) {
                    return false;
                }

                var pass = true;

                if (startVal) {
                    var startDate = new Date(startVal);
                    if (rowDate < startDate) {
                        pass = false;
                    }
                }

                if (endVal) {
                    var endDate = new Date(endVal);
                    // Make end date inclusive by adding 1 day at midnight if you want:
                    endDate.setDate(endDate.getDate() + 1);
                    if (rowDate >= endDate) {
                        pass = false;
                    }
                }

                return pass;
            });

            function redrawWithDateFilter() {
                table.draw();
            }

            if (startDateInput) startDateInput.addEventListener("change", redrawWithDateFilter);
            if (endDateInput) endDateInput.addEventListener("change", redrawWithDateFilter);

            if (clearBtn) {
                clearBtn.addEventListener("click", function () {
                    if (searchInput) searchInput.value = "";
                    if (startDateInput) startDateInput.value = "";
                    if (endDateInput) endDateInput.value = "";
                    table.search('').draw(); // clear global search
                });
            }
        });
    </script>

    <!-- NEW: Direct file upload script for "Add / Update File1" -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const addFileButtons = document.querySelectorAll(".add-file-btn");
            const hiddenFileInput = document.getElementById("hiddenFileInput");
            const hiddenRecordId = document.getElementById("hiddenRecordId");
            const hiddenUpdateFileForm = document.getElementById("hiddenUpdateFileForm");

            addFileButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const recordId = button.getAttribute("data-id");
                    hiddenRecordId.value = recordId; // Set the record id in the hidden form
                    hiddenFileInput.click(); // Directly open the file browser
                });
            });

            hiddenFileInput.addEventListener("change", function () {
                if (hiddenFileInput.files.length > 0) {
                    hiddenUpdateFileForm.submit(); // Auto-submit the form once a file is selected
                }
            });
        });
    </script>



    <script>
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.btn-preview');
            if (!btn) return;

            const fileName = btn.getAttribute('data-file');
            if (!fileName) return;

            try {
                // Hit the HoldTag FetchImage action (returns { success, url })
                const resp = await fetch('/HoldTag/FetchImage?filePath=' + encodeURIComponent(fileName));
                if (!resp.ok) { alert('Failed to fetch file.'); return; }
                const data = await resp.json();
                if (!data.success || !data.url) { alert(data.message || 'Could not retrieve file.'); return; }

                const url = data.url;
                const container = document.getElementById('previewContainer');
                if (!container) return;

                container.innerHTML = '';
                const lower = (fileName || '').toLowerCase();

                const isPdf = lower.endsWith('.pdf');
                const isVideo = lower.endsWith('.mp4') || lower.endsWith('.webm') ||
                                lower.endsWith('.ogg') || lower.endsWith('.mov') ||
                                lower.endsWith('.m4v');

                if (isPdf) {
                    const el = document.createElement('embed');
                    el.src = url;
                    el.type = 'application/pdf';
                    el.style.width = '100%';
                    el.style.height = '600px';
                    container.appendChild(el);
                } else if (isVideo) {
                    const el = document.createElement('video');
                    el.src = url;
                    el.controls = true;
                    el.style.width = '100%';
                    el.style.maxHeight = '80vh';
                    container.appendChild(el);
                } else {
                    const el = document.createElement('img');
                    el.src = url;
                    el.alt = 'Preview';
                    el.style.maxWidth = '100%';
                    el.style.maxHeight = '80vh';
                    container.appendChild(el);
                }

                new bootstrap.Modal(document.getElementById('previewModal')).show();
            } catch (err) {
                console.error('Error fetching file:', err);
                alert('Error fetching file.');
            }
        });
    </script>



    <script>
document.addEventListener("DOMContentLoaded", function() {
    const quantityInput = document.getElementById("ModalQuantity");
    const unitSelect = document.getElementById("ModalUnit");

    function updateUnitOptions() {
        const quantity = parseInt(quantityInput.value, 10);
        const isPlural = !isNaN(quantity) && quantity > 1;
        // Update each option's text based on its data attributes
        for (let option of unitSelect.options) {
            const singular = option.getAttribute("data-singular");
            const plural = option.getAttribute("data-plural");
            if (isPlural && plural) {
                option.text = plural.charAt(0).toUpperCase() + plural.slice(1);
            } else if (singular) {
                option.text = singular.charAt(0).toUpperCase() + singular.slice(1);
            }
        }
    }

    quantityInput.addEventListener("input", updateUnitOptions);
    updateUnitOptions(); // Run on page load to set the initial state
});
</script>
    <script>
        // Admin edit modal wiring (works with DataTables because of event delegation)
        document.addEventListener("DOMContentLoaded", function () {
            const tbody = document.querySelector("#holdTagTable tbody");
            if (!tbody) return;

            tbody.addEventListener("click", function (e) {
                const btn = e.target.closest(".edit-btn");
                if (!btn) return;

                const id = btn.dataset.id;
                const part = btn.dataset.part;
                const discrepancy = btn.dataset.discrepancy;
                const date = btn.dataset.date;
                const issuedBy = btn.dataset.issuedby;
                const disposition = btn.dataset.disposition;
                const dispositionBy = btn.dataset.dispositionby;
                const reworkInstr = btn.dataset.reworkinstr;
                const reworkInstrBy = btn.dataset.reworkinstrby;
                const quantity = btn.dataset.quantity;
                const unit = btn.dataset.unit;
                const pcsScrapped = btn.dataset.pcsscrapped;
                const dateCompleted = btn.dataset.datecompleted;
                const fileAddress1 = btn.dataset.fileaddress1;
                const fileAddress2 = btn.dataset.fileaddress2;
                        const prodNumber = btn.dataset.prodnumber;

                document.getElementById("edit-id").value = id;
                document.getElementById("edit-part").value = part || "";
                document.getElementById("edit-discrepancy").value = discrepancy || "";
                document.getElementById("edit-date").value = date || "";
                document.getElementById("edit-issuedby").value = issuedBy || "";
                document.getElementById("edit-disposition").value = disposition || "";
                document.getElementById("edit-dispositionby").value = dispositionBy || "";
                document.getElementById("edit-reworkinstr").value = reworkInstr || "";
                document.getElementById("edit-reworkinstrby").value = reworkInstrBy || "";
                document.getElementById("edit-quantity").value = quantity || "";
                document.getElementById("edit-unit").value = unit || "";
                document.getElementById("edit-pcsscrapped").value = pcsScrapped || "";
                document.getElementById("edit-datecompleted").value = dateCompleted || "";

                document.getElementById("edit-fileaddress1").value = fileAddress1 || "";
                document.getElementById("current-file1").innerHTML = fileAddress1
                    ? `<a href="/HoldTag/StreamFile?name=${encodeURIComponent(fileAddress1)}" target="_blank">Current File 1</a>`
                    : "No file uploaded for File 1";

                document.getElementById("edit-fileaddress2").value = fileAddress2 || "";
                document.getElementById("current-file2").innerHTML = fileAddress2
                    ? `<a href="/HoldTag/StreamFile?name=${encodeURIComponent(fileAddress2)}" target="_blank">Current File 2</a>`
                    : "No file uploaded for File 2";


        document.getElementById("edit-prodnumber").value = prodNumber || "";
                const modalEl = document.getElementById("editModal");
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            });
        });
    </script>

}
