@model DashboardReportApp.Models.TestBakeViewModel

@{
    ViewData["Title"] = "Initial Testbake Sheet";

    var departments = new[] { "Molding", "Sintering" };
    var testTypes = new[] { "Molding Test Bake", "Sintering Test Bake" };
    var reasons = new[] { "Molding Setup", "Lot Change", "Tool Change", "Density Split", "Infiltration", "Crush Test" };
}

<div class="container-fluid px-3 mt-4">
    <h2 class="text-center mb-4">Initial Testbake Sheet</h2>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @foreach (var e in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <div>@e.ErrorMessage</div>
            }
        </div>
    }

    <!-- Scan / search inputs -->
    <form asp-action="Initial" method="post" class="mb-4">
        @Html.AntiForgeryToken()
        <div class="row g-3 align-items-end">
            <div class="col-sm-3">
                <label class="form-label">Production # (scan)</label>
                <input asp-for="SearchProductionNumber" class="form-control" autocomplete="off" />
            </div>
            <div class="col-sm-3">
                <label class="form-label">Run # (scan)</label>
                <input asp-for="SearchRunNumber" class="form-control" autocomplete="off" />
            </div>
            <div class="col-sm-2">
                <label class="form-label">Department</label>
                <select asp-for="SearchDepartment" class="form-select">
                    <option value="">-- Select --</option>
                    @foreach (var d in departments)
                    {
                        <option value="@d">@d</option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <label class="form-label">Test Type</label>
                <select asp-for="SearchTestType" class="form-select">
                    <option value="">-- Select --</option>
                    @foreach (var t in testTypes)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <label class="form-label">Reason</label>
                <select asp-for="SearchReason" class="form-select">
                    <option value="">-- Select --</option>
                    @foreach (var r in reasons)
                    {
                        <option value="@r">@r</option>
                    }
                </select>
            </div>
            <div class="col-sm-2 mt-3">
                <button type="submit" class="btn btn-primary w-100">
                    Load Testbake
                </button>
            </div>
        </div>
    </form>

    @if (Model.HasResults)
    {
        <!-- Header info -->
        <div class="card mb-3">
            <div class="card-header">Header Information</div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-3"><strong>Date:</strong> @Model.Header.Date?.ToShortDateString()</div>
                    <div class="col-sm-3"><strong>Part:</strong> @Model.Header.Part</div>
                    <div class="col-sm-3"><strong>Component:</strong> @Model.Header.Component</div>
                    <div class="col-sm-3"><strong>Machine #:</strong> @Model.Header.MachineNumber</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-3"><strong>Material:</strong> @Model.Header.Material</div>
                    <div class="col-sm-3"><strong>Lot #:</strong> @Model.Header.LotNumber</div>
                    <div class="col-sm-3">
                        <label class="form-label">Tested By</label>
                        <input asp-for="Header.TestedBy" class="form-control" />
                    </div>

                    <div class="col-sm-3"><strong>Department:</strong> @Model.Header.Department</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-3"><strong>Test Type:</strong> @Model.Header.TestType</div>
                    <div class="col-sm-3"><strong>Reason:</strong> @Model.Header.Reason</div>
                    <div class="col-sm-3"><strong>Prod #:</strong> @Model.Header.ProductionNumber</div>
                    <div class="col-sm-3"><strong>Run #:</strong> @Model.Header.RunNumber</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <strong>Tool #:</strong>
                        <select asp-for="Header.ToolNumber" class="form-select">
                            <option value="">-- Select Tool --</option>
                            @foreach (var t in Model.ToolNumbers)
                            {
                                <option value="@t" selected="@(Model.Header.ToolNumber == t)">@t</option>
                            }
                        </select>
                    </div>
                    <div class="col-sm-3"><strong>Top Punch #:</strong> @Model.Header.TopPunch</div>
                    <div class="col-sm-3"><strong>Bottom Punch #:</strong> @Model.Header.BottomPunch</div>
                    <div class="col-sm-3"><strong>Die # / Pin #:</strong> @Model.Header.Die / @Model.Header.Pin</div>
                </div>
            </div>
        </div>

        <!-- Density input -->
        <div class="card mb-3">
            <div class="card-header">Density (3 Parts)</div>
            <div class="card-body">
                <table class="table table-striped table-bordered shadow-sm w-100">
                    <thead>
                        <tr>
                            <th>Sample</th>
                            <th>Dry Weight</th>
                            <th>Wet Weight</th>
                            <th>Volume</th>
                            <th>Density</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.DensityRows.Count; i++)
                        {
                            <tr>
                                <td>@Model.DensityRows[i].Index</td>
                                <td><input asp-for="DensityRows[i].DryWeight" class="form-control form-control-sm" /></td>
                                <td><input asp-for="DensityRows[i].WetWeight" class="form-control form-control-sm" /></td>
                                <td><input asp-for="DensityRows[i].Volume" class="form-control form-control-sm" /></td>
                                <td>@Model.DensityRows[i].Density</td>
                            </tr>
                        }
                    </tbody>
                </table>
                <small>You can later auto-calc density on save.</small>
            </div>
        </div>

        <!-- Dimensions table -->
        <div class="card mb-3">
            <div class="card-header">Dimensions / Tolerances / Measurements</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered shadow-sm w-100">
                        <thead>
                            <tr>
                                <th rowspan="2" class="align-middle text-center">Master Dim Name</th>

                                <th colspan="3" class="text-center">Master Molding</th>
                                <th colspan="3" class="text-center">Master Sintering</th>

                                <th colspan="5" class="text-center">Molding Test Bake (MTB)</th>
                                <th colspan="5" class="text-center">Sintering Test Bake (STB)</th>
                            </tr>
                            <tr>
                                <th>Nom</th>
                                <th>-Tol</th>
                                <th>+Tol</th>
                                <th>Nom</th>
                                <th>-Tol</th>
                                <th>+Tol</th>

                                <th>Dim Name</th>
                                <th>Nom</th>
                                <th>-Tol</th>
                                <th>+Tol</th>
                                <th>Measured</th>
                                <th>Dim Name</th>
                                <th>Nom</th>
                                <th>-Tol</th>
                                <th>+Tol</th>
                                <th>Measured</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in Model.Dimensions)
                            {
                                <tr>
                                    <td>@d.MasterMoldName</td>

                                    <td>@(d.MasterMoldNominal?.ToString("0.0000"))</td>
                                    <td>@(d.MasterMoldTolMinus?.ToString("0.0000"))</td>
                                    <td>@(d.MasterMoldTolPlus?.ToString("0.0000"))</td>

                                    <td>@(d.MasterSinterNominal?.ToString("0.0000"))</td>
                                    <td>@(d.MasterSinterTolMinus?.ToString("0.0000"))</td>
                                    <td>@(d.MasterSinterTolPlus?.ToString("0.0000"))</td>

                                    <td>@d.MoldName</td>
                                    <td>@(d.MoldNominal?.ToString("0.0000"))</td>
                                    <td>@(d.MoldTolMinus?.ToString("0.0000"))</td>
                                    <td>@(d.MoldTolPlus?.ToString("0.0000"))</td>
                                    <td>@(d.MoldMeasurement?.ToString("0.0000"))</td>

                                    <td>@d.SinterName</td>
                                    <td>@(d.SinterNominal?.ToString("0.0000"))</td>
                                    <td>@(d.SinterTolMinus?.ToString("0.0000"))</td>
                                    <td>@(d.SinterTolPlus?.ToString("0.0000"))</td>
                                    <td>@(d.SinterMeasurement?.ToString("0.0000"))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sintering details -->
        <div class="card mb-3">
            <div class="card-header">Sintering Details (Test Bake)</div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <label class="form-label">Sinter Operator</label>
                        <input asp-for="SinterInfo.SinterOperator" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Time Started</label>
                        <input asp-for="SinterInfo.TimeStartedSinter" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Oven</label>
                        <input asp-for="SinterInfo.Oven" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Belt Speed</label>
                        <input asp-for="SinterInfo.BeltSpeed" class="form-control" />
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <label class="form-label">Pre-Heat Temp</label>
                        <input asp-for="SinterInfo.PreHeatTemp" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">High Heat Temp</label>
                        <input asp-for="SinterInfo.HighHeatTemp" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Dewpoint</label>
                        <input asp-for="SinterInfo.DewPoint" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Parts Currently in Furnace</label>
                        <input asp-for="SinterInfo.PartsCurrentlyInFurnace" class="form-control" />
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <label class="form-label">Mix # of Parts in Furnace</label>
                        <input asp-for="SinterInfo.MixNumberOfPartsInFurnace" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Method</label>
                        <input asp-for="SinterInfo.Method" class="form-control" />
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label">Orientation</label>
                        <input asp-for="SinterInfo.Orientation" class="form-control" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Outcome placeholder -->
        <div class="card mb-3">
            <div class="card-header">Outcome</div>
            <div class="card-body">
                <p>This section will be filled out later (approved / rejected, reason, by who, date).</p>
            </div>
        </div>
    }
</div>
