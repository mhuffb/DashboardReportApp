@{

    ViewData["Title"] = "Press Mix Bag Change";
    var operators = ViewData["OperatorList"] as List<string> ?? new List<string>();
    var equipment = ViewData["EquipmentList"] as List<string> ?? new List<string>();

    // Dictionary containing Part → (Run, Machine)
    var openPartsWithRunsAndMachines = ViewData["OpenPartsWithRunsAndMachines"] as Dictionary<string, (string Run, string Machine)>
                                       ?? new Dictionary<string, (string, string)>();
}

<div class="container mt-4">
    <h1 class="text-center mb-4">Press Mix Bag Change</h1>

    <form asp-action="Submit" method="post">
        <div class="row">
            <!-- Part Selection -->
            <div class="col-md-6 mb-3">
                <label for="Part" class="form-label">Part:</label>
                <select id="Part" name="Part" class="form-control" required onchange="updateHiddenRunAndMachine()">
                    <option value="">-- Select Part --</option>
                    @foreach (var entry in openPartsWithRunsAndMachines)
                    {
                        <!-- Key = Part, Value = (Run, Machine) -->
                        var partNumber = entry.Key;
                        var runNumber = entry.Value.Run;
                        var machine = entry.Value.Machine;

                        <option value="@partNumber"
                                data-run="@runNumber"
                                data-machine="@machine">
                            @partNumber (Run: @runNumber)
                        </option>
                    }
                </select>
            </div>

            <!-- HIDDEN Run Number -->
            <input type="hidden" id="RunNumber" name="RunNumber" />

            <!-- Operator Dropdown -->
            <div class="col-md-6 mb-3">
                <label for="Operator" class="form-label">Operator:</label>
                <select id="Operator" name="Operator" class="form-control">
                    <option value="">-- Select Operator --</option>
                    @foreach (var op in operators)
                    {
                        <option value="@op">@op</option>
                    }
                </select>
            </div>

            <!-- Machine (Now auto-populated) -->
            <div class="col-md-6 mb-3">
                <label for="Machine" class="form-label">Machine:</label>
                <input type="text" id="Machine" name="Machine" class="form-control" readonly />
            </div>

            <div class="col-md-6 mb-3">
                <label for="LotNumber" class="form-label">Lot Number:</label>
                <input type="text" id="LotNumber" name="LotNumber" class="form-control" required />
            </div>

            <div class="col-md-6 mb-3">
                <label for="MixNumber" class="form-label">Mix Number:</label>
                <input type="text" id="MixNumber" name="MixNumber" class="form-control" required />
            </div>

            <div class="col-md-12 mb-3">
                <label for="Note" class="form-label">Notes:</label>
                <textarea id="Note" name="Note" class="form-control text-area-large"></textarea>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3"><i class="bi bi-check-circle"></i> Submit</button>
    </form>
</div>

<script>
    function updateHiddenRunAndMachine() {
        const partSelect = document.getElementById("Part");
        const runHidden = document.getElementById("RunNumber");
        const machineInput = document.getElementById("Machine");

        const selectedOption = partSelect.options[partSelect.selectedIndex];
        if (!selectedOption) return;

        // Get run number and machine from the selected option
        const runValue = selectedOption.getAttribute("data-run") || "";
        const machineValue = selectedOption.getAttribute("data-machine") || "";

        // Update hidden fields
        runHidden.value = runValue;
        machineInput.value = machineValue;
    }
</script>
