
@using System.Linq
@using DashboardReportApp.Models

@{
    var holdKeys = ViewBag.HoldKeys as HashSet<string>
        ?? new HashSet<string>(StringComparer.OrdinalIgnoreCase);
}

@{
    ViewData["Title"] = "Press Run Log - Split Tables, Login, & Start Skid Modal";

    // Operators for the login form
    var operators = ViewData["Operators"] as List<string> ?? new List<string>();

    // Dictionary of (part, run) => machine (raw machine code, e.g. "2")
    var openParts = ViewData["OpenParts"] as List<DashboardReportApp.Models.PressSetupModel>
                      ?? new List<DashboardReportApp.Models.PressSetupModel>();

    // All open records (records with EndDateTime == null)
    var openRecords = ViewBag.OpenRuns as List<DashboardReportApp.Models.PressRunLogModel>
                      ?? new List<DashboardReportApp.Models.PressRunLogModel>();

    // Split open records into main run records (SkidNumber == 0) and skid records (SkidNumber > 0)
    var mainRuns = openRecords.Where(r => r.SkidNumber == 0).ToList();
    var skids = openRecords.Where(r => r.SkidNumber > 0).ToList();

   
}
<style>
    /* Hard yellow */
    .table-warning,
    .table-warning > td,
    .table-warning > th {
        background-color: #ffeb3b !important; /* yellow */
    }

    .hold-banner td {
        border-bottom: 2px solid #b58900;
    }
</style>


@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

<div class="container-fluid px-3">
   
    <div class="table-responsive">
        <h1 class="text-center mb-4">Press Run Log</h1>

        <!-- Parts Setup and Ready to Mold -->
        <h2 class="text-center">Parts Currently Setup and Available to Run</h2>
        <div class="card shadow mb-4">
            <div class="card-body">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Prod Number</th>
                            <th>Run</th>
                            <th>Notes</th>
                            <th>End DateTime</th>
                            <th>Setup By</th>
                            <th>Machine</th>
                            <th>Part</th>
                            <th>Component</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in openParts)
                        {
                            <tr>
                                <td>@item.ProdNumber</td>
                                <td>@item.Run</td>
                                <td>@item.Notes</td>
                                <td>@(item.EndDateTime.HasValue ? item.EndDateTime.Value.ToString("yyyy-MM-dd HH:mm") : "Open")</td>
                                <td>@item.Operator</td>
                                <td>@item.Machine</td>
                                <td>@item.Part</td>
                                <td>@item.Component</td>
                                <td>
                                    <button class="btn btn-primary btn-sm"
                                            onclick="openLoginModalForRun('@item.Part', '@item.Component', '@item.Run', '@item.Machine', '@item.ProdNumber')">
                                        Login to Run
                                    </button>
                                    <span>&nbsp;</span>
                                    <button class="btn btn-danger btn-sm"
                                            onclick="openEndRunModalByRun('@item.Run', '@item.Machine')">
                                        End Run
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Open Mold Production Operator Runs -->
        <h2 class="text-center mb-4">Open Mold Production Operator Runs</h2>
        <div class="card shadow mb-4">
            <div class="card-body">
                @if (mainRuns.Any())
                {
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Prod Number</th>
                                <th>Run</th>
                                <th>Mix Lot</th>       
                                <th>Mix Code</th>
                                <th>Start Time</th>
                                <th>Operator</th>
                                <th>Machine</th>
                                <th>Part</th>
                                <th>Component</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rec in mainRuns)
                            {
                                <tr>
                                    <td>@rec.Id</td>
                                    <td>@rec.ProdNumber</td>
                                    <td>@rec.Run</td>
                                    <td>@rec.LotNumber</td>      
                                    <td>@rec.MaterialCode</td>
                                    <td>@(rec.StartDateTime?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</td>
                                    <td>@rec.Operator</td>
                                    <td>@rec.Machine</td>
                                    <td>@rec.Part</td>
                                    <td>@rec.Component</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm"
                                                onclick="openLogoutModal('@rec.Id', '@rec.Machine')">
                                            Logout
                                        </button>

                                        <span>&nbsp;</span>

                                        <button class="btn btn-info btn-sm"
                                                onclick="openStartSkidModal('@rec.Id', '@rec.Machine', '@rec.Part', '@rec.Component', '@rec.Operator', '@rec.Run', '@rec.ProdNumber')">
                                            Start Skid
                                        </button>

                                        <span>&nbsp;</span>

                                        <a class="btn btn-warning btn-sm"
                                           asp-controller="TestBake"
                                           asp-action="Index"
                                           asp-route-run="@rec.Run"
                                           asp-route-prodNumber="@rec.ProdNumber"
                                           asp-route-operatorName="@rec.Operator">
                                            Test Bake
                                        </a>
                                    </td>

                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>No open run records.</p>
                }
            </div>
        </div>

        <!-- Open Skid Records -->
        <h2 class="text-center mb-4">Open Skids</h2>
        <div class="card shadow mb-4">
            <div class="card-body">
                @if (skids.Any())
                {
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Prod Number</th>
                                <th>Run</th>
                                <th>Mix Lot</th>   
                                <th>Mix Code</th>
                                <th>Start Time</th>
                                <th>SkidNumber</th>
                                <th>Pcs Start</th>
                                <th>Operator</th>
                                <th>Machine</th>
                                <th>Part</th>
                                <th>Component</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var skid in skids)
                            {
                                // 🔸 adjust this condition if your flag name differs
                                bool isOnHold = holdKeys.Contains(
                                HoldKeyHelper.HoldKey("pressrun", skid.ProdNumber, skid.Run, skid.Part, skid.SkidNumber)
                                );


                                if (isOnHold)
                                {
                                    <tr class="table-warning">
                                        <td colspan="13" class="fw-bold text-center">
                                            🚫 ON HOLD
                                        </td>
                                    </tr>
                                }

                                <tr class="@(isOnHold ? "table-warning" : "")">
                                    <td>@skid.Id</td>
                                    <td>@skid.ProdNumber</td>
                                    <td>@skid.Run</td>
                                    <td>@skid.LotNumber</td>   
                                    <td>@skid.MaterialCode</td> 
                                    <td>@skid.StartDateTime</td>
                                    <td>@skid.SkidNumber</td>
                                    <td>@skid.PcsStart</td>
                                    <td>@skid.Operator</td>
                                    <td>@skid.Machine</td>
                                    <td>@skid.Part</td>
                                    <td>@skid.Component</td>
                                    <td>
                                        <form method="post" asp-action="GenerateRouterTag" asp-controller="PressRunLog">
                                            <input type="hidden" name="Id" value="@skid.Id" />
                                            <input type="hidden" name="Part" value="@skid.Part" />
                                            <input type="hidden" name="Component" value="@skid.Component" />
                                            <input type="hidden" name="ProdNumber" value="@skid.ProdNumber" />
                                            <input type="hidden" name="Run" value="@skid.Run" />
                                            <input type="hidden" name="Machine" value="@skid.Machine" />
                                            <input type="hidden" name="Operator" value="@skid.Operator" />
                                            <input type="hidden" name="SkidNumber" value="@skid.SkidNumber" />
                                            <input type="hidden" name="StartDateTime" value="@skid.StartDateTime" />
                                            <input type="hidden" name="PcsStart" value="@skid.PcsStart" />
                                            <input type="hidden" name="PcsEnd" value="@skid.PcsEnd" />
                                            <!-- For open skids, EndDateTime is null. This will be empty if null. -->
                                            <input type="hidden" name="EndDateTime" value="@(skid.EndDateTime.HasValue ? skid.EndDateTime.Value.ToString("yyyy-MM-dd HH:mm:ss") : "")" />

                                            <button type="submit" class="btn btn-primary btn-sm">Print Router Tag</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>No open skid records.</p>
                }
            </div>
        </div>

        <!-- All Runs (DataTables) -->
        <h2 class="text-center mb-4">All Press Runs</h2>
        <div class="card shadow mb-4">
            <div class="card-body">
                <table id="pressrunTable" class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Part</th>
                            <th>Component</th>
                            <th>Prod Number</th>
                            <th>Run</th>
                            <th>Mix Lot</th>
                            <th>Sched Material</th>
                            <th>Scanned Mix Code</th>
                            <th>Override By</th>
                            <th>Machine</th>
                            <th>Operator</th>
                            <th>Skid #</th>
                            <th>Pcs</th>
                            <th>Duration (hrs)</th>
                            <th>Date</th>
                            <th>Scrap</th>
                            <th>Notes</th>
                            <th>Actions</th>

                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>
        

<script>

    // LOGIN: Set hidden values (including component) and open the modal
           function openLoginModalForRun(part, component, run, machine, prodNumber) {
        document.getElementById("loginPartHidden").value = part;
        document.getElementById("loginComponentHidden").value = component;
        document.getElementById("loginRunHidden").value = run;
        document.getElementById("loginMachineHidden").value = machine;
        document.getElementById("loginProdHidden").value = prodNumber;
        document.getElementById("loginOperatorSelect").selectedIndex = 0;

        const pcsStartInput = document.getElementById("loginPcsStart");
        pcsStartInput.value = "Loading...";

        let modal = new bootstrap.Modal(document.getElementById("LoginModal"));
        modal.show();

        fetch(`/PressRunLog/ApiGetDeviceCount?machine=${encodeURIComponent(machine)}`)
            .then(response => response.json())
            .then(data => {
                pcsStartInput.value = data.deviceCount ?? 0;
                pcsStartInput.dataset.originalCount = pcsStartInput.value;
            })
            .catch(err => {
                console.error("Error fetching count:", err);
                pcsStartInput.value = "Error";
            });
    }



    // LOGOUT: Set hidden value and open modal (no device count fetch)
           function openLogoutModal(runId, machine) {
        document.getElementById("logoutRunId").value = runId;
        document.getElementById("logoutScrap").value = "0";
        document.getElementById("logoutNotes").value = "";
        document.getElementById("logoutMachineHidden").value = machine;   

        let modal = new bootstrap.Modal(document.getElementById("LogoutModal"));
        modal.show();

        const display = document.getElementById("logoutDeviceCountDisplay");
        const original = display.value;

        fetch(`/PressRunLog/ApiGetDeviceCount?machine=${encodeURIComponent(machine)}`)
            .then(response => response.json())
            .then(data => {
                const count = data.deviceCount ?? 0;

                // Only update if user hasn't touched it yet
                if (display.value === "" || display.value === "0" || display.value === original || display.value === "Loading...") {
                    display.value = count;
                }

            display.dataset.originalCount = display.value;
            })
            .catch(err => {
                console.error("Error fetching count:", err);
                if (display.value === "" || display.value === "Loading...") {
                    display.value = "Error";
                }
            });
    }



       function openEndRunModalByRun(run, machine) {
        document.getElementById("endRunRunValue").value = run;
        document.getElementById("endRunMachineHidden").value = machine;

        const endCountInput = document.getElementById("endRunFinalCount");
        endCountInput.value = "0";
        endCountInput.dataset.originalCount = "0";

        let modal = new bootstrap.Modal(document.getElementById("EndRunCountModal"));
        modal.show();

        fetch(`/PressRunLog/ApiGetDeviceCount?machine=${encodeURIComponent(machine)}`)
            .then(response => response.json())
            .then(data => {
                endCountInput.value = data.deviceCount ?? 0;
                endCountInput.dataset.originalCount = endCountInput.value;
            })
            .catch(err => console.error("Error fetching device count:", err));
    }


    // START SKID: Asks for a count override
    function openStartSkidModal(runId, machine, part, component, operator, run, prodNumber) {
        console.log("openStartSkidModal called with", runId, machine, part, component, operator, run, prodNumber);
        document.getElementById("startSkidRunId").value = runId;
        document.getElementById("startSkidRunValue").value = run;
        document.getElementById("startSkidMachineHidden").value = machine;
        document.getElementById("startSkidPartHidden").value = part;
        document.getElementById("startSkidComponentHidden").value = component;
        document.getElementById("startSkidOperatorHidden").value = operator;
        document.getElementById("startSkidProdHidden").value = prodNumber;

        const pcsStartInput = document.getElementById("startSkidPcsStart");
        const defaultValue = pcsStartInput.value;

        console.log("Initial Pcs Start Value:", pcsStartInput.value);

        let modal = new bootstrap.Modal(document.getElementById("StartSkidModal"));
        modal.show();

        fetch(`/PressRunLog/ApiGetDeviceCount?machine=${encodeURIComponent(machine)}`)
            .then(response => response.json())
            .then(data => {
                if (pcsStartInput.value === defaultValue) {
                    pcsStartInput.value = data.deviceCount || 0;
    pcsStartInput.dataset.originalCount = pcsStartInput.value;   // NEW

                    console.log("Updated Pcs Start Value from API:", pcsStartInput.value);
                }
            })
            .catch(err => console.error("Error fetching device count:", err));
    }




</script>

<!-- Inline Modals -->
<!-- (A) Login Modal (without count) -->
<div id="LoginModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm" method="post" asp-controller="PressRunLog" asp-action="ConfirmLogin">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="loginPartHidden" name="part" />
                    <input type="hidden" id="loginComponentHidden" name="component" />
                    <input type="hidden" id="loginMachineHidden" name="machine" />
                    <input type="hidden" id="loginProdHidden" name="ProdNumber" />
                    <input type="hidden" id="loginRunHidden" name="Run" />
                    <!-- Show current count -->
                    <div class="mb-3">
                        <label class="form-label">Starting Device Count (editable):</label>
                        <input type="number" id="loginPcsStart" class="form-control" name="pcsStart" value="0" />
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox"
                               id="loginSetCountDevice"  checked>
                        <label class="form-check-label" for="loginSetCountDevice">
                            Set count on device
                        </label>
                    </div>


                    <div class="mb-3">
                        <label for="loginOperatorSelect" class="form-label">Operator</label>
                        <select id="loginOperatorSelect" name="operator" class="form-select" required>
                            <option value="">Select an operator</option>
                            @foreach (var op in operators)
                            {
                                <option value="@op">@op</option>
                            }
                        </select>
                    </div>
                            

                    <button type="submit" class="btn btn-primary w-100">Confirm Login</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- (B) Logout Modal (without count) -->
<div id="LogoutModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Logout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="logoutForm" method="post" asp-controller="PressRunLog" asp-action="ConfirmLogout">
                    <input type="hidden" id="logoutRunId" name="runId" />
                    <!-- Display current count -->
                    <input type="hidden" id="logoutMachineHidden" />

                    <div class="mb-3">
                        <label class="form-label">Current Device Count:</label>
                        <input type="text" id="logoutDeviceCountDisplay" class="form-control" name="finalCount" />
                    </div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox"
                               id="logoutSetCountDevice" checked>
                        <label class="form-check-label" for="logoutSetCountDevice">
                            Set count on device
                        </label>
                    </div>


                    <div class="mb-3">
                        <label class="form-label">Scrap:</label>
                        <input type="number" id="logoutScrap" name="scrap" class="form-control" value="0" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes:</label>
                        <textarea id="logoutNotes" name="notes" class="form-control"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Confirm Logout</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- (C) End Run Modal (asks for count; ends main run & any open skid) -->
<div id="EndRunCountModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">End Run (Device Count)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="endRunForm" method="post"  asp-controller="PressRunLog" asp-action="ConfirmEndRun">
                    <input type="hidden" id="endRunRunValue" name="run" />

                    <input type="hidden" id="endRunMachineHidden" name="machine" />

                    <div class="mb-3">
                        <label class="form-label">Final Count (Override if needed):</label>
                        <input type="number" id="endRunFinalCount" name="finalCount" class="form-control" value="0" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Scrap:</label>
                        <input type="number" id="endRunScrap" name="scrap" class="form-control" value="0" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes:</label>
                        <textarea id="endRunNotes" name="notes" class="form-control"></textarea>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="endRunOrderComplete" name="orderComplete" value="true" />
                        <label class="form-check-label" for="endRunOrderComplete">Order Complete?</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input"
                               id="endRunSetCountDevice" checked>
                        <label class="form-check-label" for="endRunSetCountDevice">
                            Set count on device
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Confirm End Run</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- (D) Start Skid Modal (asks for starting count) -->
<div id="StartSkidModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Skid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                        <form id="startSkidForm" method="post" asp-controller="PressRunLog" asp-action="StartSkid">

                    @Html.AntiForgeryToken()
                    <input type="hidden" id="startSkidRunId" name="runId" />
                    <input type="hidden" id="startSkidRunValue" name="run" />
                    <input type="hidden" id="startSkidMachineHidden" name="machine" />
                    <input type="hidden" id="startSkidPartHidden" name="part" />
                    <input type="hidden" id="startSkidComponentHidden" name="component" />
                    <input type="hidden" id="startSkidOperatorHidden" name="operator" />
                    <input type="hidden" id="startSkidProdHidden" name="prodNumber" />

                    <div class="mb-3">
                        <label class="form-label">Pcs Start (Override if needed):</label>
                        <input type="number" id="startSkidPcsStart" name="pcsStart" class="form-control" value="0" />
                    </div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox"
                               id="startSkidSetCountDevice" checked>
                        <label class="form-check-label" for="startSkidSetCountDevice">
                            Set count on device
                        </label>
                    </div>
                           

                    <button type="submit" class="btn btn-primary w-100">Confirm Start Skid</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

            <script>
                // ---------- shared helper for logout / end run ----------
                function wireCountAndAjax(formId, cntId, chkId, machId) {
                    const f = document.getElementById(formId);
                    if (!f) return;

                    f.addEventListener('submit', async ev => {
                        if (f.dataset.submitted === 'true') {
                            ev.preventDefault();
                            return;
                        }
                        ev.preventDefault();
                        f.dataset.submitted = 'true';

                        /* optional device push */
                        try {
                            const cnt  = document.getElementById(cntId);
                            const chk  = document.getElementById(chkId);
                            const mach = document.getElementById(machId)?.value;
                            const ip   = (window.deviceIPs || {})[mach];
                            const orig = cnt?.dataset.originalCount ?? '';

                            if (chk?.checked && cnt && ip && cnt.value.trim() !== orig) {
                                await fetch(`http://${ip}/update`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: `count_value=${encodeURIComponent(cnt.value)}`
                                });
                            }
                        } catch (e) {
                            console.warn('Device push failed:', e);
                        }

                        /* main AJAX submit */
                        try {
                            const fd  = new FormData(f);
                            const tok = f.querySelector('input[name="__RequestVerificationToken"]')?.value;

                            // default to POST if method is empty
                            let method = (f.method || 'POST').toUpperCase();

                            const options = {
                                method,
                                headers: {
                                    'Accept': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    ...(tok ? { RequestVerificationToken: tok } : {})
                                }
                            };

                            // Only attach body for non-GET/HEAD
                            if (method !== 'GET' && method !== 'HEAD') {
                                options.body = fd;
                            }

                            const resp = await (window.fetchWithSpinner
                                ? window.fetchWithSpinner(f.action, options)
                                : fetch(f.action, options));

                            const json = await resp.json();

                            if (json.ok) {
                                await Swal.fire({
                                    icon: 'success',
                                    title: json.message || 'Done',
                                    timer: 3000,
                                    showConfirmButton: false
                                });
                                location.reload();
                            } else {
                                throw new Error(json.message || 'Request failed');
                            }
                        } catch (err) {
                            Swal.fire('Error', err.message || 'Network error', 'error');
                        } finally {
                            f.dataset.submitted = 'false';
                        }
                    });
                }

                // ---------- supervisor override helpers for Login / Start Skid ----------
                document.addEventListener('DOMContentLoaded', function () {
                    // Forms that need override support (PIN)
                    hookOverrideForm('#loginForm',
                                     '/PressRunLog/ConfirmLogin',
                                     'Login',
                                     'LoginModal');

                    hookOverrideForm('#startSkidForm',
                                     '/PressRunLog/StartSkid',
                                     'Start Skid',
                                     'StartSkidModal');

                    // Forms that still use the old device-push + spinner flow
                    wireCountAndAjax('logoutForm',
                                     'logoutDeviceCountDisplay',
                                     'logoutSetCountDevice',
                                     'logoutMachineHidden');

                    wireCountAndAjax('endRunForm',
                                     'endRunFinalCount',
                                     'endRunSetCountDevice',
                                     'endRunMachineHidden');
                });

                function hookOverrideForm(formSelector, url, actionLabel, modalId) {
                    const form = document.querySelector(formSelector);
                    if (!form) return;

                    // ✅ Prevent double-wiring the same form
                    if (form.dataset.overrideHooked === '1') {
                        return;
                    }
                    form.dataset.overrideHooked = '1';

                    form.addEventListener('submit', async function (e) {
                        e.preventDefault(); // stop normal form post
                        const formData = new FormData(form);

                        try {
                            await doOverrideFlow(url, formData, actionLabel, modalId);
                        } catch (err) {
                            console.error(err);
                            Swal.fire({
                                icon: 'error',
                                title: actionLabel + ' failed',
                                text: 'Unexpected error occurred.'
                            });
                        }
                    });
                }
                                // 🔹 Shared reason prompt (required)
                async function promptOverrideReason() {
                  const r = await Swal.fire({
                    icon: 'question',
                    title: 'Override Reason',
                    input: 'text',
                    inputLabel: 'Why is this override needed?',
                    inputPlaceholder: 'Enter reason (required)',
                    inputAttributes: {
                      maxlength: 255,
                      autocapitalize: 'off',
                      autocorrect: 'off',
                      autocomplete: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Continue',
                    cancelButtonText: 'Cancel',
                    allowOutsideClick: false,

                    // ✅ THIS makes it NOT close when blank
                    preConfirm: (value) => {
                      const v = (value || '').trim();
                      if (!v) {
                        Swal.showValidationMessage('Please enter a reason (required).');
                        return false;
                      }
                      return v;
                    }
                  });

                  if (!r.isConfirmed) return null;
                  return r.value; // trimmed by preConfirm
                }

                async function doOverrideFlow(url, formData, actionLabel, modalId, overridePin, overrideReason) {

                    if (overridePin) {
                        formData.set('overridePin', overridePin);
                    }
                                    if (overrideReason) {
                  formData.set('overrideReason', overrideReason);
                }

                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    let payload;
                    let rawText;
                    try {
                        rawText = await res.text();
                        payload = rawText ? JSON.parse(rawText) : {};
                    } catch (e) {
                        console.error('Non-JSON response:', rawText);
                        await Swal.fire({
                            icon: 'error',
                            title: actionLabel + ' failed',
                            text: 'Server did not return valid JSON.'
                        });
                        return;
                    }

                    const successFlag = (payload.ok === true || payload.success === true);

                    // ✅ Success path
                    if (res.ok && successFlag) {
                        await Swal.fire({
                            icon: 'success',
                            title: actionLabel + ' Successful',
                            text: payload.message || (actionLabel + ' completed.')
                        });
                        location.reload();
                        return;
                    }

                                          if (res.status === 400 && !overridePin) {
                    const msg = payload.message || 'Supervisor override required.';

                    // Hide Bootstrap modal so it doesn't trap focus
                    const modalEl = document.getElementById(modalId);
                    if (modalEl) {
                        const inst = bootstrap.Modal.getInstance(modalEl);
                        if (inst) inst.hide();
                    }

                    const result = await Swal.fire({
                        icon: 'warning',
                        title: 'Supervisor / Material Override',
                        html: `<p style="text-align:left;">${msg}</p>`,

                        // 🔹 Use TEXT instead of PASSWORD to defeat autofill
                        input: 'text',
                        inputLabel: 'Override PIN',
                        inputPlaceholder: 'Enter override PIN',

                        // 🔹 Force blank & try to kill autofill
                        inputValue: '',
                        inputAttributes: {
                            maxlength: 10,
                            autocapitalize: 'off',
                            autocorrect: 'off',
                            autocomplete: 'off',
                            // random name so browser can't match previous field
                            name: 'override_' + Date.now(),
                            inputmode: 'numeric'      // optional, nicer keypad on mobile
                        },

                        showCancelButton: true,
                        confirmButtonText: 'Submit PIN',
                        cancelButtonText: 'Cancel',
                        allowOutsideClick: false,

                        didOpen: () => {
                            const input = Swal.getInput();
                            if (input) {
                                // belt + suspenders: nuke any value browser tried to slip in
                                input.value = '';
                                input.setAttribute('autocomplete', 'off');
                                input.focus();

                                // extra nuke for aggressive autofill: clear again on a tiny delay
                                setTimeout(() => {
                                    if (input.value !== '') input.value = '';
                                }, 50);
                            }
                        }
                    });

                    if (!result.isConfirmed || !result.value) {
                        return; // user cancelled
                    }

                                   const pin = result.value;

                // ✅ NEW: prompt for reason (required)
                const reason = await promptOverrideReason();
                if (!reason) return;

                // 🔁 Retry with overridePin + overrideReason
                return await doOverrideFlow(url, formData, actionLabel, modalId, pin, reason);

                }


                    // ❌ If we got here with a second 400 (bad PIN or other failure)
                    const rawCode = payload.code || payload.errorCode || payload.status || payload.error || '';
                    const code = rawCode.toString().toUpperCase();
                    const message = payload.message || 'An error occurred.';

                                    if (code === 'OVERRIDE_REASON_REQUIRED') {
                  await Swal.fire({
                    icon: 'error',
                    title: 'Reason Required',
                    text: message || 'Override reason is required.'
                  });
                  return;
                }


                    if (code === 'BAD_PIN') {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Invalid PIN',
                            text: message
                        });
                        return;
                    }

                    await Swal.fire({
                        icon: 'error',
                        title: actionLabel + ' failed',
                        text: message
                    });
                }
            </script>

            <script>
            function getAntiForgeryToken() {
    // grabs any anti-forgery token already on the page (your modals include them)
    const el = document.querySelector('input[name="__RequestVerificationToken"]');
    return el ? el.value : '';
}


    document.addEventListener('DOMContentLoaded', function () {
        if (window.jQuery && $.fn.DataTable) {
            $('#pressrunTable').DataTable({
                processing: true,
                serverSide: true,      // we’re paging on the server
                searching: true,
                pageLength: 50,
                lengthMenu: [[10, 25, 50, 100],   // no "All" now
                             [10, 25, 50, 100]],
                                order: [[14, 'desc']], // Date
                            // 13 = Start Time column

                ajax: function (data, callback) {
                    // DataTables -> your API params
                    const page     = Math.floor(data.start / data.length) + 1;
                    const pageSize = data.length;
                    const q        = data.search && data.search.value ? data.search.value : '';

                    $.getJSON('/PressRunLog/ApiRuns', {
                        page: page,
                        pageSize: pageSize,
                        q: q
                    }, function (json) {
                        callback({
                            data: json.rows,
                            recordsTotal: json.total,
                            recordsFiltered: json.total
                        });
                    });
                },

                               columns: [
                  { data: 'id' },
                  { data: 'part' },
                  { data: 'component' },
                  { data: 'prodNumber' },
                  { data: 'run' },
                  { data: 'lotNumber' },

                  { data: 'scheduledMaterial' },

                  {
                    data: 'materialCode',
                    render: function (data, type, row) {
                      const sched = row.scheduledMaterial || '';
                      const mix   = data || '';
                      if (!sched && !mix) return '';
                      if (sched === mix) return mix;
                      return `<span style="color:red;" title="Scheduled: ${sched}">${mix}</span>`;
                    }
                  },

                  { data: 'overrideBy' },
                  { data: 'machine' },
                  { data: 'operator' },
                  { data: 'skidNumber' },

                  // ✅ NEW
                  { data: 'pcs' },
                  { data: 'durationHours' },
                  {
                    data: 'runDate',
                    render: function (data) {
                      if (!data) return '';
                      const d = new Date(data);
                      if (isNaN(d)) return data;
                      return d.toLocaleDateString();
                    }
                  },

                  { data: 'scrap' },
                  { data: 'notes' },

                                  {
                  data: null,
                  orderable: false,
                  searchable: false,
                  render: function (data, type, row) {

                    // ✅ Show HOLD badge if on hold
                    if (row.onHold === true) {
                      return `
                        <div class="d-flex flex-column gap-1">
                          <span class="badge bg-danger fw-bold">🚫 ON HOLD</span>
                          <a class="btn btn-secondary btn-sm disabled" href="#" tabindex="-1" aria-disabled="true">
                            Place on Hold
                          </a>
                        </div>
                      `;
                    }

                    const skidNum = row.skidNumber || 0;
                    if (skidNum === 0) return '';

                    const run = row.run || '';
                    const prod = row.prodNumber || '';
                    const source = 'pressrun';

                    const url =
                      `/HoldTag?source=${encodeURIComponent(source)}` +
                      `&run=${encodeURIComponent(run)}` +
                      `&prodNumber=${encodeURIComponent(prod)}` +
                      `&skidNumber=${encodeURIComponent(skidNum)}`;

                    return `<a class="btn btn-warning btn-sm" href="${url}">Place on Hold</a>`;
                  }
                }

                


                
                             // Notes
                                                                ],  rowCallback: function (row, data) {
                  $(row).removeClass('table-warning');
                  if (data.onHold === true) {
                    $(row).addClass('table-warning');
                  }
                }


            });
        } else {
            console.warn('DataTables not found; table will be plain HTML.');
        }
    });
</script>
          
}



@if (TempData["Toast"] != null)
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            Swal.fire({ icon: "success", title: "@TempData["Toast"]" });
        });
    </script>
}





       
    