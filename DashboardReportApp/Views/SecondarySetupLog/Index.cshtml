@model DashboardReportApp.Models.SecondarySetupLogViewModel

@using System.Text.Json

<div class="container mt-4">
    <h1 class="text-center mb-4">Secondary Setup Log</h1>
    <div class="d-flex justify-content-center mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#setupModal">
            Add Setup
        </button>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="setupModal" tabindex="-1" aria-labelledby="setupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setupModalLabel">Start Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="CreateSetup" method="post" id="setupForm">
                    <div class="mb-3">
                        <label for="Operator" class="form-label">Operator:</label>
                        <select id="Operator" name="Operator" class="form-control bg-black text-goldenrod border-goldenrod" required>
                            <option value="">-- Select Operator --</option>
                            @foreach (var op in Model.Operators)
                            {
                                <option value="@op">@op</option>
                            }

                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="Machine" class="form-label">Machine:</label>
                        <select id="Machine" name="Machine" class="form-control bg-black text-goldenrod border-goldenrod" required>
                            <option value="">-- Select Machine --</option>
                            @foreach (var machine in Model.Machines)
                            {
                                <option value="@machine">@machine</option>
                            }

                        </select>
                    </div>

                    <!-- Schedule Dropdown with data-ops attribute -->
                    <div class="mb-3">
                        <label for="ScheduleOption" class="form-label">Select Part:</label>
                        <select id="ScheduleOption" name="ScheduleOption" class="form-control bg-black text-goldenrod border-goldenrod" required>
                            <option value="">-- Select Part --</option>
                            @* 
                                Note: We now assume that each ScheduleItem has a Run property.
                                The option value is formatted as: "Part|ProdNumber|Run"
                            *@
                            @foreach (var item in Model.ScheduleItems)
                            {
                                <option value="@($"{item.Part}|{item.ProdNumber}|{item.Run}")" data-ops="@item.NumberOfSintergySecondaryOps">
                                    @($"{item.Part} (Production Number: {item.ProdNumber} Run: {item.Run})")
                                </option>
                            }

                        </select>
                    </div>

                    <!-- Hidden fields to store Part, ProdNumber, and Run -->
                    <input type="hidden" id="Part" name="Part" />
                    <input type="hidden" id="ProdNumber" name="ProdNumber" />
                    <input type="hidden" id="Run" name="Run" />

                    <!-- Op Dropdown that will be populated dynamically -->
                    <div class="mb-3">
                        <label for="Op" class="form-label">Op:</label>
                        <select id="Op" name="Op" class="form-control bg-black text-goldenrod border-goldenrod" required>
                            <option value="">-- Select Op --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="Pcs" class="form-label">Pieces:</label>
                        <input type="number" id="Pcs" name="Pcs" class="form-control bg-black text-goldenrod border-goldenrod" />
                    </div>

                    <div class="mb-3">
                        <label for="ScrapMach" class="form-label">Machined Scrap:</label>
                        <input type="number" id="ScrapMach" name="ScrapMach" class="form-control bg-black text-goldenrod border-goldenrod" />
                    </div>

                    <div class="mb-3">
                        <label for="ScrapNonMach" class="form-label">Non-Machined Scrap:</label>
                        <input type="number" id="ScrapNonMach" name="ScrapNonMach" class="form-control bg-black text-goldenrod border-goldenrod" />
                    </div>

                    <div class="mb-3">
                        <label for="Notes" class="form-label">Notes:</label>
                        <textarea id="Notes" name="Notes" class="form-control bg-black text-goldenrod border-goldenrod text-area-large"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="SetupHours" class="form-label">Setup Hours:</label>
                        <input type="number" step="0.1" id="SetupHours" name="SetupHours" class="form-control bg-black text-goldenrod border-goldenrod" />
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="submitButton">
                        <i class="bi bi-play-circle"></i> Add Setup
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<h3 class="text-center mt-4">All Runs</h3>
<div class="card shadow mb-4">
    <div class="card-body">
        <form class="row g-2 mb-3" method="get" action="/SecondarySetupLog/Index">
            <div class="col-sm-4">
                <input name="search" value="@Model.Search" class="form-control" placeholder="Search Prod/Part/Operator/Machine" />
            </div>
            <div class="col-sm-2">
                <select name="pageSize" class="form-select">
                    @foreach (var size in new[] { 25, 50, 100, 200 })
                    {
                        <option value="@size" selected="@(Model.PageSize == size)">
                            @size / page
                        </option>
                    }
                </select>
            </div>
            <div class="col-sm-2">
                <select name="sort" class="form-select">
                    <option value="id" selected="@(Model.Sort=="id")">ID</option>
                    <option value="date" selected="@(Model.Sort=="date")">Date</option>
                    <option value="prodNumber" selected="@(Model.Sort=="prodNumber")">Prod #</option>
                    <option value="part" selected="@(Model.Sort=="part")">Part</option>
                    <option value="operator" selected="@(Model.Sort=="operator")">Operator</option>
                    <option value="machine" selected="@(Model.Sort=="machine")">Machine</option>
                </select>
            </div>
            <div class="col-sm-2">
                <select name="dir" class="form-select">
                    <option value="DESC" selected="@(Model.Dir=="DESC")">Desc</option>
                    <option value="ASC" selected="@(Model.Dir=="ASC")">Asc</option>
                </select>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-primary w-100">Apply</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-bordered shadow-sm wider-table">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Prod #</th>
                        <th>Run</th>
                        <th>Part</th>
                        <th>Op</th>
                        <th>Operator</th>
                        <th>Setup Hours</th>
                        <th>Machine</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in Model.PageItems)
                    {
                        <tr>
                            <td>@row.Id</td>
                            <td>@row.Date</td>
                            <td>@row.ProdNumber</td>
                            <td>@row.Run</td>
                            <td>@row.Part</td>
                            <td>@row.Op</td>
                            <td>@row.Operator</td>
                            <td>@row.SetupHours</td>
                            <td>@row.Machine</td>
                            <td>@row.Notes</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @{
            var firstItem = (Model.Total == 0) ? 0 : ((Model.Page - 1) * Model.PageSize) + 1;
            var lastItem = Math.Min(Model.Page * Model.PageSize, Model.Total);
            var totalPages = (int)Math.Ceiling((double)Model.Total / Model.PageSize);
            string qsBase = $"?search={Model.Search}&pageSize={Model.PageSize}&sort={Model.Sort}&dir={Model.Dir}";
        }
        <div class="d-flex justify-content-between align-items-center">
            <div>Showing <strong>@firstItem–@lastItem</strong> of <strong>@Model.Total</strong></div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.Page<=1?"disabled":"")">
                        <a class="page-link" href="@($"/SecondarySetupLog{qsBase}&page={Model.Page-1}")">Prev</a>
                    </li>
                    @for (int p = Math.Max(1, Model.Page - 2); p <= Math.Min(totalPages, Model.Page + 2); p++)
                    {
                        <li class="page-item @(p==Model.Page?"active":"")">
                            <a class="page-link" href="@($"/SecondarySetupLog{qsBase}&page={p}")">@p</a>
                        </li>
                    }
                    <li class="page-item @(Model.Page>=totalPages?"disabled":"")">
                        <a class="page-link" href="@($"/SecondarySetupLog{qsBase}&page={Model.Page+1}")">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- JavaScript to update hidden fields and the "Op" dropdown dynamically -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var scheduleOption = document.getElementById("ScheduleOption");
        var opDropdown = document.getElementById("Op");
        var partField = document.getElementById("Part");
        var prodNumberField = document.getElementById("ProdNumber");
        var runField = document.getElementById("Run");

        function updateHiddenFieldsAndOps() {
            var selectedOption = scheduleOption.options[scheduleOption.selectedIndex];
            var value = selectedOption.value;
            var opsCount = parseInt(selectedOption.getAttribute("data-ops"));
            console.log("Selected value:", value, "Ops count:", opsCount);

            if (value) {
                var parts = value.split("|");
                if (parts.length === 3) {
                    partField.value = parts[0];
                    prodNumberField.value = parts[1];
                    runField.value = parts[2];
                    console.log("Hidden fields set - Part:", partField.value, "ProdNumber:", prodNumberField.value, "Run:", runField.value);
                }
            } else {
                partField.value = "";
                prodNumberField.value = "";
                runField.value = "";
                console.log("No value selected; hidden fields cleared");
            }

            // Clear and update the Op dropdown
            opDropdown.innerHTML = '<option value="">-- Select Op --</option>';
            if (!isNaN(opsCount) && opsCount > 0) {
                for (var i = 1; i <= opsCount; i++) {
                    var option = document.createElement("option");
                    option.value = i;
                    option.text = i;
                    opDropdown.appendChild(option);
                }
            }
        }

        scheduleOption.addEventListener("change", updateHiddenFieldsAndOps);
        // Trigger update on page load in case an option is preselected
        updateHiddenFieldsAndOps();
    });
</script>

<!-- Load your React bundle -->
<script src="/js/mydatatable.bundle.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById("myReactTableRoot");
        if (!container) return;

        const rawData = container.getAttribute("data-records");
        const data = JSON.parse(rawData);

        const columns = [
            { key: "Id", label: "ID" },
            { key: "Date", label: "Date" },
            { key: "ProdNumber", label: "ProdNumber" },
            { key: "Run", label: "Run #" },
            { key: "Part", label: "Part" },
            { key: "Op", label: "Op" },
            { key: "Operator", label: "Operator" },
            { key: "SetupHours", label: "Setup Hours" },
            { key: "Machine", label: "Machine" },
            { key: "Notes", label: "Notes" }
        ];

        if (window.renderMyDataTable) {
            window.renderMyDataTable("myReactTableRoot", data, columns, true);
        } else {
            console.error("React table render function not found!");
        }
    });
</script>
<script>
    document.getElementById("setupForm").addEventListener("submit", function () {
      var submitButton = document.getElementById("submitButton");
      if (submitButton) {
        submitButton.disabled = true;
      }
    });
</script>